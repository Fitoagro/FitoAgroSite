<!DOCTYPE html>
<html>
  <head>
    <title>Página principal</title>
    <meta charset="utf-8" />
    <script src="https://kit.fontawesome.com/16512b04b3.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>

  <body>
    <div class="header">
      <img src="resources/images/fitoagro_logo.png" style="height: 40px; padding-bottom: 4px; align-self: center; margin-right: 64px">
      <div id="visits_tab" onclick="window.location.reload()" style="cursor:pointer; margin-right: 20px; padding:6px; font-size: 16px; text-decoration: underline; color: white">Visitas</div>
      <div id="stats_tab" onclick="window.location.href = 'stats.html'" style="cursor:pointer; padding:6px; font-size: 16px; color: white">Estatísticas</div>
      <div style="margin-left: auto; align-self: center">
          <!--Add buttons to initiate auth sequence and sign out-->
          <div id="user_name" style="font-size: 20px; padding-top: 3px"> </div>
          <button type="button" class="btn light-button" style="background-color: lightgray; color: black; display: inline-block; float: right" id="signout_button">Logout</button>
      </div>
    </div>

    <div id="login" style="display: none; flex-direction: column; justify-content: center; align-items: center">
      <div style="display:flex; flex-direction:column; justify-content: center; align-items: center; padding: 48px; margin-top: 10%; background-color: lightgray; border-radius: 3px; box-shadow: 5px 5px 5px darkgrey">
          <i class="fa fa-lock" style="font-size: 70px; color: #008577;"></i>
        <br><br>
        <h4>Por favor faça login:</h4>
        <br>
          <button type="button" class="btn light-button" style=" width: 100%; display: none;" id="authorize_button">Entrar</button>
      </div>
    </div>

    <div id="content" class="content" >
      <div style="display: flex; flex-direction: row; align-items: flex-start; padding-bottom: 1rem; margin-bottom:1rem; border-bottom: 1px solid #00574B">
        <pre id="visits" style="padding-left: 24px; margin: 0; white-space: pre-wrap;"></pre>
        <div style="margin-left: auto;">
            <i style="color: #008577; font-size: 16px; padding-right: 6px;" class="fas fa-filter"></i>
            <select id="filterplots" class="selectpicker" data-live-search-placeholder="Pesquisar..." onchange="filterPlots()" multiple data-live-search="true" title="Nenhuma parcela"
                    data-actions-box="true" data-size="10" data-deselect-all-text="Limpar" data-select-all-text="Todas" data-header="Selecionar Parcelas">
              <option selected title="AZ" value="Azambujeira dos Carros">Azambujeira dos Carros (AZ)</option>
              <option selected title="BB" value="Barreiras da Bica">Barreiras da Bica (BB)</option>
              <option selected title="BL" value="Boiça do Louro">Boiça do Louro (BL)</option>
              <option selected title="BRC" value="Barrocalvo">Barrocalvo (BRC)</option>
              <option selected title="CS" value="Casal Serrano">Casal Serrano (CS)</option>
              <option selected title="DG" value="Dagorda">Dagorda (DG)</option>
              <option selected title="ENC" value="Encarnação">Encarnação (ENC)</option>
              <option selected title="ISC" value="Iscarção III">Iscarção III (ISC)</option>
              <option selected title="JB" value="João Boi">João Boi (JB)</option>
              <option selected title="MAR" value="Marmelos">Marmelos (MAR)</option>
              <option selected title="QB" value="Quinta do Brejo">Quinta do Brejo (QB)</option>
              <option selected title="QR" value="Quinta do Rato">Quinta do Rato (QR)</option>
              <option selected title="SL" value="São Lourenço">São Lourenço (SL)</option>
              <option selected title="TER" value="Termas">Termas (TER)</option>
              <option selected title="VF" value="Vale da Fonte">Vale da Fonte (VF)</option>
              <option selected title="VL" value="Vale Leite">Vale Leite (VL)</option>
            </select>
        </div>
        <div class="dropdown" style="margin-right: 48px; margin-left: 24px; height: 40px">
          <i style="color: #008577; font-size: 16px; padding-right: 6px;" class="fas fa-list"></i>
          <button type="button" class="btn light-button" style="width:200px; text-align: left !important;
           background-color: #f8f9fa; font-weight: normal; color: black" id="sorting">Não Agrupado
            <i style="position: absolute; right: 8px; top: 12px" class="fas fa-caret-down"></i></button>
          <ul class="dropdown-menu" role="menu" style="width:200px; margin-left:28px">
            <li id="groupby-none" onclick="updateList(this.id)" style="cursor: pointer; padding: 8px 8px 8px 24px">
              <a>Não Agrupado <i id="groupby-none-icon"style=" position: absolute; right: 8px; top: 12px; color: #008577" class="fas fa-check-circle"></i></a>
            </li>
            <!--<li class="divider"><hr style="height: 1px; margin: 0; padding: 0"></li>
            <li id="groupby-technician" onclick="updateList(this.id)" style="padding: 8px 8px 8px 24px">
              <a>Técnico <i id="groupby-technician-icon"style="visibility: hidden; margin-left: 10px; color: #008577" class="fas fa-check-circle"></i></a>
            </li>!-->
            <li class="divider"><hr style="height: 1px; margin: 0; padding: 0"></li>
            <li id="groupby-plot" onclick="updateList(this.id)" style="cursor: pointer; padding: 8px 8px 8px 24px">
              <a>Por Parcela <i id="groupby-plot-icon" style="visibility: hidden; position: absolute; right: 8px; top: 54px; color: #008577" class="fas fa-check-circle"></i></a>
            </li>
          </ul>
          <!--<ul class="dropdown-menu multi-level dropdown-menu-right" role="menu" aria-labelledby="dropdownMenu">
            <li class="dropdown-submenu">
              <a tabindex="-1">Agrupar por</a>

            </li>
            <li class="divider"><hr style="height: 1px; margin: -1px; padding: 0"></li>
            <li class="dropdown-submenu" style="">
              <a tabindex="-1">Ordenar por</a>
              <ul class="dropdown-menu" role="menu" style="margin-left:1px; margin-top: -1px">
                <li id="orderby-date" onclick="updateList(this.id)" style="padding: 8px 8px 8px 24px">
                  <a tabindex="-1">Data <i id="orderby-date-icon" style="margin-left: 50px; color: #008577" class="fas fa-sort-amount-down"></i></a>
                </li>
                <li class="divider"><hr style="height: 1px; margin: 0; padding: 0"></li>
                <li id="orderby-name" onclick="updateList(this.id)" style="padding: 8px 8px 8px 24px">
                  <a>Nome <i id="orderby-name-icon" style=" visibility: hidden; margin-left: 50px; color: #008577" class="fas fa-sort-amount-up"></i></a>
                </li>
              </ul>
            </li>
          </ul>!-->
        </div>
      </div>
      <div id="renderList" style="margin-top: 12px; margin-left:6px; display: flex; flex-direction: column"></div>

    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <script type="text/javascript">

      var fontFamily = '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,' +
              '"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"';

      var currentOrder = "orderby-date";
      var orderDirection = 0; //1 = descending ; 0 = asccending
      var currentGrouping = "groupby-none";

      // Client ID and API key from the Developer Console
      var CLIENT_ID = '697021054229-c7jjbfpfmjkrnoqjo2pg7nfj7v1a1f95.apps.googleusercontent.com';
      var API_KEY = 'AIzaSyCMSb0abab-1ALwctezS4mWo8AalLXI9KI';
      /** LOCALHOST ONLY **/

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = 'https://www.googleapis.com/auth/drive';

      var loginForm = document.getElementById('login');
      var authorizeButton = document.getElementById('authorize_button');
      var userName = document.getElementById('user_name');
      var signoutButton = document.getElementById('signout_button');
      var content = document.getElementById('content');

      var users = [];
      var visits = [];
      var plots = [];
      var filter = [];

      var lastDevice;
      var fullName;

      var region_info = {};
      var enemy_acronym = {};

      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        sessionStorage.clear();
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);


          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        }, function(error) {
          appendPre(JSON.stringify(error, null, 2),false);
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {

          var currentUser = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
          fullName = currentUser.getName();

          document.getElementById("visits_tab").style.visibility = "visible";
          document.getElementById("stats_tab").style.visibility = "visible";

          authorizeButton.style.display = 'none';
          loginForm.style.display = 'none';
          signoutButton.style.visibility = 'visible';
          userName.innerHTML = fullName;
          userName.style.display = 'inline-block';

          content.style.display = 'flex';


          gapi.client.drive.files.get({
            'fileId': '1u3bhE_SCCGCSUc3aFACFoD2QuDkMnM81',
            'alt': 'media',
          }).then(function (response) {
            region_info = {};
            enemy_acronym = {};

            for(var i = 0; i < response.result.length; i++){
              var actual_region = response.result[i];
              region_info[actual_region['codigo']] = actual_region['inimigo'];
            }


            gapi.client.drive.files.get({
              'fileId': '1iKLtUE3msrXY0t6VxV54LjbjKs5C_eR2',
              'alt': 'media',
            }).then(function (response) {
              var lines = response.body.split('\n');
              for(var i = 0 ; i < lines.length; i++){
                var aux = lines[i].split(',');
                enemy_acronym[aux[1].replace(/(\r\n|\n|\r)/gm, "")] = aux[0];
              }

              console.log(region_info, enemy_acronym);
              listUsers();

            },function(error){
              console.error(error)
              listUsers();
            });



          },function(error){
            console.error(error)
            listUsers();
          });



        } else {
          document.getElementById("visits_tab").style.visibility = "hidden";
          document.getElementById("stats_tab").style.visibility = "hidden";
          authorizeButton.style.display = 'inline-block';
          loginForm.style.display = 'flex';
          userName.innerText ="";
          userName.style.display = 'none';
          signoutButton.style.visibility = 'hidden';
          content.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();

      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
		document.getElementById("renderList").innerHTML = "";
		document.getElementById('visits').innerHTML = "";
        document.getElementById('visits').removeChild('h3');
		visits = [];
		plots = [];
      }

      /**
       * Append a pre element to the body containing the given message
       * as its text node. Used to display the results of the API call.
       *
       * @param {string} message Text to be placed in pre element.
       */
      function appendPre(message,header) {
        var pre = document.getElementById('visits');
        var textContent = document.createElement('h3');
        if(header)
          textContent.setAttribute('id','header');
        textContent.innerText = message;
        textContent.style.fontFamily = fontFamily;
        pre.appendChild(textContent);
      }

      function listUsers() {
        var fileID = '1RgkniTJ-VtkilglCzo8dAqALLIgFffWg';
        gapi.client.drive.files.list({
          'folderId' : fileID,
          'pageSize': 100,
          'fields': "nextPageToken, files(id, name, owners)",
          'q': `'${fileID}' in parents`
        }).then(function(response) {
          var files = response.result.files;
          //Everything is loaded

          files.forEach(setUsers);
        });
      }

      function listVisits(fileID, user) {
        if(visits.length === 0)
          appendPre('Visitas de Campo',true);
        gapi.client.drive.files.list({
          'folderId' : fileID,
          'pageSize': 100,
          'fields': "nextPageToken, files(id, name, owners)",
          'q': `'${fileID}' in parents`
        }).then(function(response) {
          var files = response.result.files;
          //Everything is loaded

          for(var i = 0; i < files.length; i++){
            if(files[i].name === "info.csv"){
              gapi.client.drive.files.get({
                'fileId': files[i].id,
                'alt': 'media',
              }).then(function(response) {
                var file = response.body;
                var lines = file.split(/\r\n|\n/);
                var headers = lines[0].split('|');
                var userVisits = [];
                for(var i = 1; i < lines.length; i++){
                  var currentLine = lines[i].split('|');
                  var info = [];
                  info.push({user: user});
                  for(var j=0; j < headers.length; j++) {
                    info.push({[headers[j]]:currentLine[j]});
                  }
                  info = info.reduce(((r, c) => Object.assign(r, c)), {});

                  if(!plots.includes(info.plotName))
                    plots.push(info.plotName);

                  userVisits.push(info);
                  visits.push(info);
                }
                console.log(visits);

                var div = document.getElementById('renderList');
                var visitsDiv = document.createElement('div');
                visitsDiv.style.display = "flex";
                visitsDiv.style.flexDirection = "row";
                visitsDiv.style.flexWrap = "wrap";
                visitsDiv.style.justifyContent = "flex-start";
                visitsDiv.style.alignItems = "flex-start";
                visitsDiv.style.width = "100%";
                div.appendChild(visitsDiv);
                console.log('no list')
               // render(visitsDiv, userVisits);
                setFilter();
                updateList(currentGrouping);
              });
            }
          }

        });
      }

      function setUsers(element, index, arr) {
        if(element != null){
          if (element.name === "dep.tecnico.apas@gmail.com") { /** Testing Device */
            users.push({id: element.id, name: element.name, username : element.owners[0].displayName});
            console.log(users);
            listVisits(element.id, element.id);
          }
        }
      }

      function updateList(id) {

        var div = document.getElementById('renderList');
        div.innerHTML = "";

        if (visits.length === 0){
          var noVisits = document.createElement('div');
          noVisits.innerHTML = "Sem Visitas";
          div.appendChild(noVisits);
          return;
        }

        if(id.includes("groupby")){
          document.getElementById(currentGrouping + "-icon").style.visibility = "hidden";
          document.getElementById(id + "-icon").style.visibility = "visible";
          var selected = id.includes("none") ? "Não Agrupado" : "Agrupado por parcela";
          document.getElementById("sorting").innerHTML = selected + '<i style=\"position: absolute; right: 8px; top: 12px\" class=\"fas fa-caret-down\"></i>';
          currentGrouping = id;
        }

        var filtered = visits;

        function updateSort() {
          switch (id) {
            case "orderby-date":
              if ((currentOrder === id && orderDirection === 0) || currentOrder !== id) {
                orderDirection = 1;
                document.getElementById(id + "-icon").setAttribute("class", "fas fa-sort-amount-down");
              } else{
                orderDirection = 0;
                document.getElementById(id + "-icon").setAttribute("class", "fas fa-sort-amount-up");
              }
              break;
            case "orderby-name":
              if ((currentOrder === id && orderDirection === 1) || currentOrder !== id) {
                orderDirection = 0;
                document.getElementById(id + "-icon").setAttribute("class", "fas fa-sort-amount-up");
              } else {
                orderDirection = 1;
                document.getElementById(id + "-icon").setAttribute("class", "fas fa-sort-amount-down");
              }
              break;
          }
          document.getElementById(currentOrder + "-icon").style.visibility = "hidden";
          document.getElementById(id + "-icon").style.visibility = "visible";
          currentOrder = id;
        }

        switch (currentGrouping) {
          case "groupby-technician":
            for(var i=0; i< users.length; i++){
              filtered = visits.filter(value => value.user === users[i].id);
              filtered = sort(id, filtered);
              if(filtered.length > 0) {
                var techName = document.createElement('h5');
                techName.innerText = users[i].name + '\n';
                techName.style.fontFamily = fontFamily;
                div.appendChild(techName);
                var techDiv = document.createElement('div');
                techDiv.style.display = "flex";
                techDiv.style.flexDirection = "row";
                techDiv.style.flexWrap = "wrap";
                techDiv.style.marginTop = "6px";
                techDiv.style.justifyContent = "flex-start";
                techDiv.style.alignItems = "flex-start";
                techDiv.style.width = "100%";
                div.appendChild(techDiv);
                console.log('no group1');
                render(techDiv, filtered);
              }
            }
            if(!id.includes("groupby"))
              updateSort();
            break;
          case "groupby-plot":
            var list = visits.filter(value => filter.includes(value.plotName));
            for(var i=0; i< plots.length; i++){
              plots = plots.sort(function (a, b) {
                return ((a < b) ? -1 : ((a > b) ? 1 : 0));
              });
              filtered = list.filter(value => value.plotName === plots[i]);
              if(filtered.length === 0)
                continue;
              filtered = sort(id, filtered);
              var plotTitle = document.createElement('h5');
              plotTitle.innerText = plots[i] + '\n';
              plotTitle.style.fontFamily = fontFamily;
              plotTitle.style.textAlign = "center";
              plotTitle.style.padding = "6px";
              plotTitle.style.backgroundColor = "#f8f9fa";
              div.appendChild(plotTitle);
              var plotDiv = document.createElement('div');
              plotDiv.style.display = "flex";
              plotDiv.style.flexDirection = "row";
              plotDiv.style.flexWrap = "wrap";
              plotDiv.style.marginTop = "6px";
              plotDiv.style.justifyContent = "flex-start";
              plotDiv.style.alignItems = "flex-start";
              plotDiv.style.width = "100%";
              div.append(plotDiv);
              console.log('no group2');

              render(plotDiv, filtered);
            }
            if(!id.includes("groupby"))
              updateSort();
            break;
          case "groupby-none":
          default:
            var divElement = document.createElement('div');
            divElement.style.display = "flex";
            divElement.style.flexDirection = "row";
            divElement.style.flexWrap = "wrap";
            divElement.style.marginTop = "6px";
            divElement.style.justifyContent = "flex-start";
            divElement.style.alignItems = "flex-start";
            divElement.style.width = "100%";
            div.append(divElement);
            filtered = visits.filter(value => filter.includes(value.plotName));
            filtered = sort(id, filtered);
            console.log('no group3');

            render(divElement, filtered);

            if(!id.includes("groupby"))
              updateSort();
            break;
        }
      }

      function setFilter() {
        filter = [];
        var e = document.getElementById("filterplots");
        for(var i=0; i<e.options.length; i++){
          if(!plots.includes(e.options[i].value)) {
            e.options[i].disabled = true; //TODO: not working
          }else {
            e.options[i].selected = true;
            filter.push(e.options[i].value);
          }
        }
      }
      
      function filterPlots() {
        filter = [];
        var e = document.getElementById("filterplots");
        for(var i=0; i<e.options.length; i++){
          if(e.options[i].selected)
            filter.push(e.options[i].value);
        }
        updateList(currentGrouping);
      }

      function sort(id, visits) {
        var type;
        if(id.includes("groupby"))
          type = currentOrder.split("-")[1];
        else
          type = id.split("-")[1];

        switch (type) {
              case "date":
                if(id.includes("groupby")){
                  visits = orderDirection === 1 ? sortByDateDesc(visits) : sortByDateAsc(visits);
                } else if((currentOrder === id && orderDirection === 0) || currentOrder !== id) {
                  visits = sortByDateAsc(visits);
                } else{
                  visits = sortByDateDesc(visits);
                }
                function sortByDateAsc(visits) {
                visits.sort(function (a, b) { //sort by name asc
                    return ((a.date < b.date) ? 1 : ((a.date > b.date) ? -1 : 0));
                });
                return visits;
              }
                function sortByDateDesc(visits) {
                visits.sort(function (a, b) { //sort by name desc
                    return ((a.date < b.date) ? -1 : ((a.date > b.date) ? 1 : 0));
                });
                return visits;
              }
                break;
              case "name":
                if(id.includes("groupby")) {
                  visits = orderDirection === 0 ? sortByNameAsc(visits) : sortByNameDesc(visits);
                } else if((currentOrder === id && orderDirection === 1) || currentOrder !== id) {
                  visits = sortByNameAsc(visits);
                }else{
                  visits = sortByNameDesc(visits);
                }
                function sortByNameAsc(visits) {
                  visits.sort(function (a, b) { //sort by name asc
                      return ((a.plot < b.plot) ? -1 : ((a.plot > b.plot) ? 1 : 0));
                  });
                  return visits;
                }
                function sortByNameDesc(visits) {
                  visits.sort(function (a, b) { //sort by name desc
                      return ((a.plot < b.plot) ? 1 : ((a.plot > b.plot) ? -1 : 0));
                  });
                  return visits;
                }
                break;
        }
        return visits;
      }

      function render(div, list) {
        var success_counter = 0;
        for(var i=0; i<list.length; i++) {
          if(list[i].plot !== undefined) {
            success_counter ++;
            var box = document.createElement('div');
            box.setAttribute('class', 'grid');
            box.setAttribute('id', list[i].fileId);
            box.onclick = function () {
              var visit = visits.find(value => value.fileId === this.id);
              sessionStorage.setItem('visit', JSON.stringify(visit));
              sessionStorage.setItem('users', JSON.stringify(users));
              var plotVisits = visits.filter(value => value.plot === visit.plot);
              sessionStorage.setItem('plotVisits', JSON.stringify(plotVisits));
              window.location.href = 'visit.html?visit_id=' + this.id;
            };
            var title = document.createElement('span');
            var text = document.createElement('a');
            var icon = document.createElement('a');
            var topIcon = list[i].rain === "true" ? '<img src="resources/images/rain_icon.png" style="width:30px;height:30px">'
                    : list[i].treatment === "true" ? '<img src="resources/images/treatment_icon.png" style="width:30px;height:30px">' : '';
            title.style.borderBottom = "1px solid grey";
            title.style.fontSize = "16px";
            title.style.color = "#008577";
            title.style.fontWeight = "bold";
            title.style.lineHeight = 'unset';
            title.style.height = "35px";
            title.style.paddingBottom = "8px";
            title.style.marginBottom = "12px";
            title.style.paddingLeft = "3px";
            title.style.width = "165px";

            var space = list[i].plot != undefined && list[i].plot.length == 2 ? '&emsp;&emsp;' : '&ensp;&emsp;';
            text.innerHTML = list[i].plot + space + refactorDate(list[i].date);
            icon.innerHTML = topIcon;
            icon.style.marginLeft = '18px';
            title.appendChild(text);
            title.appendChild(icon);


            var ef_nea = document.createElement('a');
            var ef = list[i].ef;
            if (list[i].ef === "null")
              ef = "--";
            if (list[i].nea === "null")
              ef_nea.innerHTML = "<b>EF: </b>" + ef;
            else
              ef_nea.innerHTML = "<b>EF: </b>" + ef + "&emsp;&emsp;&emsp;" + "<b>NEA: </b>" + list[i].nea;
            ef_nea.style.marginBottom = '8px';
            var content = document.createElement('a');

            var tooltip = document.createElement('span');
            tooltip.setAttribute('class', 'tooltiptext');

            var notestr = list[i].notes;

            var overall = list[i].overall;

            // if (typeof overall !== undefined && overall.length > 23)
            //   overall = overall.split("|")[0] + "|" + overall.split("|")[1] + "|" + overall.split("|")[2] + "|" + overall.split("|")[3] + " | ...";
            //
            if (overall === "null")
              overall = '&nbsp;';

            var aux = typeof overall !== undefined ? overall.split(" / ") : undefined;


            if (list[i].notes === "null")
              notestr = '&nbsp;';
            else if(notestr.length > 30){
              tooltip.innerText = notestr;
              notestr = notestr.substr(0,30) + '...';
            }else if(notestr.length > 18 && typeof aux !== undefined){
              tooltip.innerText = notestr;
              notestr = notestr.substr(0,18) + '...';
            }

            if (typeof aux !== undefined && aux.length > 1) {

              var region_info_clone = JSON.parse(JSON.stringify(region_info));
              console.log(region_info_clone);


              var main_enemies =  region_info_clone[list[i].plot];

              for(var w = 0; w < main_enemies.length; w ++){
                main_enemies[w] = enemy_acronym[main_enemies[w]];
              }

              var main_enemies_string = '';
              var not_main = '';
              for(w = 0; w < aux.length ; w ++){
                var actual_enemy = aux[w].replace(/[0-9]/g, '');
                console.log(actual_enemy);
                if (main_enemies.some(e => e === actual_enemy)) {
                  if(main_enemies_string.localeCompare('') !== 0)
                    main_enemies_string += ' / ';
                  main_enemies_string += aux[w];

                }else{
                  if(not_main.localeCompare('') !== 0)
                    not_main += ' / ';
                  not_main += aux[w];
                }
              }
              overall = main_enemies_string + ' / ' + not_main;
              aux = overall.split(' / ');
              console.log(overall);
              tooltip.innerText += '\n' + aux.join(" / ");
              box.appendChild(tooltip);
              overall = aux[0] + " / " + aux[1] + " / ...";
            }

            if (list[i].visited === "false") {
              overall = "Visita não efetuada";
              if (list[i].notes === "null") {
                content.innerHTML = '<p style="font-size: 14px; margin-bottom: 5px">' + overall + '</p>';
                content.style.lineHeight = "3";
              } else
                content.innerHTML = '<p style="font-size: 14px; margin-bottom: 5px">' + overall + '</p>' + '<p style="margin-bottom: 0">' + notestr + '</p>';
            } else if (list[i].notes === "null") {
              content.innerHTML = '<p style=" font-size: 14px; height: 50px; align-content: center; margin-bottom: 0">' + overall + '</p>';
              content.style.lineHeight = "3";
            } else
              content.innerHTML = '<p style="margin-bottom: 5px">' + notestr + '</p>' + '<p style="font-size: 14px; margin-bottom: 0">' + overall + '</p>';

            content.style.alignSelf = "center";
            content.style.textAlign = "center";
            content.style.justifySelf = "center";
            content.style.marginBottom = "16px";
            content.style.fontSize = "16px";
            var multimedia = document.createElement('a');
            var photos = '<i class="fas fa-camera" style="font-size: 20px; color: #008577"/>' +
                    '<a style="font-size: 14px; font-family: sans-serif; font-weight: normal">' + " " + list[i].numPhotos + '</a>';
            var audio = '<i class="fas fa-microphone" style="padding-left: 12px; font-size: 20px; color: #008577"/>' +
                    '<a style="font-size: 14px; font-family: sans-serif; font-weight: normal;">' + " " + list[i].numVoice + '</a>';
            var gpsIcon = list[i].gps === "false" ? '&ensp;&ensp;<img src="resources/images/no_gps_icon.png" style="width:30px;height:30px">' :
                    '&emsp;&ensp;&ensp;&ensp;';
            var user = users.find(value => value.id === list[i].user);
            var userNames = user.username.split(" ");
            var userPhoto = '<a id="user_icon" style="color: dimgrey; font-weight: bolder; font-family:sans-serif; font-size: 14px; width: 30px; height: 30px; line-height: unset;' +
                    '-webkit-border-radius: 25px; -moz-border-radius: 25px; border-radius: 25px; padding-top:5px;padding-bottom:5px; padding-left:3px; padding-right:3px; background-color: white">'
                    + userNames[0].substr(0, 1).toUpperCase() + userNames[userNames.length - 1].substr(0, 1).toUpperCase() + '</a>';
            var userIcon = list[i].technicians.split(";").length === 1 ? '&thinsp;&ensp;' + userPhoto :
                    '&thinsp;&ensp;<img src="resources/images/coop_icon.png" style="width:30px;height:30px">';
            multimedia.innerHTML = photos + audio + gpsIcon + userIcon;
            multimedia.style.alignSelf = "left";
            multimedia.style.color = "#008577";
            box.appendChild(title);
            box.appendChild(ef_nea);
            box.appendChild(content);
            box.appendChild(multimedia);

            //li.onclick = function(){onDeviceClick(this.getAttribute('id'))};

            div.appendChild(box);

            //li.innerHTML=li.innerHTML + element.name;
          }
        }

        document.getElementById('header').innerText  = 'Visitas de Campo (' + success_counter + ')'
        //TODO
      }

      function refactorDate(date) {
        if(date != undefined) {
          var values = date.split('/');
          var month = "";
          switch (values[1]) { //get month
            case '01':
              month = " Jan ";
              break;
            case '02':
              month = " Fev ";
              break;
            case '03':
              month = " Mar ";
              break;
            case '04':
              month = " Abr ";
              break;
            case '05':
              month = " Mai ";
              break;
            case '06':
              month = " Jun ";
              break;
            case '07':
              month = " Jul ";
              break;
            case '08':
              month = " Ago ";
              break;
            case '09':
              month = " Set ";
              break;
            case '10':
              month = " Out ";
              break;
            case '11':
              month = " Nov ";
              break;
            case '12':
              month = " Dez ";
              break;
          }
          return values[2] + month /*+ values[0].substr(2)*/;
        }
        return null;
      }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>








<!--<DOCTYPE! html>

<html>

<head>

	<style>
      #map {
        width: 100%;
        height: 400px;
        background-color: grey;
      }
    </style>
	
	<script src="js/javascript.js"></script>

</head>

<body>



    <h3>My Google Maps Demo</h3>
    <div id="map"></div>
	<script language="javascript">
		initMap();
	</script>
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
    </script>

</body>


</html>-->
