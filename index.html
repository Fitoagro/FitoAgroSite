<!DOCTYPE html>
<html>
  <head>
    <title>Página principal</title>
    <meta charset="utf-8" />
    <script src="https://kit.fontawesome.com/16512b04b3.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>

  <body>
    <div class="header">
      <img src="resources/images/fitoagro_logo.png" style="height: 50px; align-self: center; cursor: pointer; margin-right: 32px">
      <div id="visits_tab" onclick="window.location.reload()" style="cursor:pointer; padding:8px; font-size: 20px; text-decoration: underline; color: white">Visitas</div>
      <div id="stats_tab" onclick="window.location.href = 'stats.html'" style="cursor:pointer; padding:8px; font-size: 20px; color: white">Estatísticas</div>
      <div style="margin-left: auto; align-self: center">
          <!--Add buttons to initiate auth sequence and sign out-->
          <div id="user_name"> </div>
          <button type="button" class="btn light-button" style="background-color: lightgray; color: black; display: none; float: right;  " id="signout_button">Logout</button>
      </div>
    </div>

    <div id="login" style="display: none; flex-direction: column; justify-content: center; align-items: center">
      <div style="display:flex; flex-direction:column; justify-content: center; align-items: center; padding: 48px; margin-top: 10%; background-color: lightgray; border-radius: 3px; box-shadow: 5px 5px 5px darkgrey">
          <i class="fa fa-lock" style="font-size: 70px; color: #008577;"></i>
        <br><br>
        <h4>Por favor faça login:</h4>
        <br>
          <button type="button" class="btn light-button" style=" width: 100%; display: none;" id="authorize_button">Entrar</button>
      </div>
    </div>

    <div id="content" class="content" >
      <div style="display: flex; flex-direction: row; align-items: flex-start; padding-bottom: 1rem; margin-bottom:1rem; margin-right:1%; border-bottom: 1px solid #00574B">
        <pre id="visits" style="margin: 0; white-space: pre-wrap;"></pre>
        <div style="margin-left: auto; margin-right: 16px">
          <!--Add buttons to initiate auth sequence and sign out-->
          <div class="dropdown">
            <button type="button" class="btn light-button" style="background-color: #008577; color: white; border-radius: 50%" id="sorting">
            <i style="font-size: 20px" class="fas fa-sort"></i></button>
            <ul class="dropdown-menu multi-level dropdown-menu-right" role="menu" aria-labelledby="dropdownMenu">
              <li class="dropdown-submenu">
                <a tabindex="-1">Agrupar por</a>
                <ul class="dropdown-menu" role="menu" style="margin-left:1px; margin-top: 1px">
                  <li id="groupby-plot" onclick="updateList(this.id)" style="padding: 8px 8px 8px 24px">
                    <a tabindex="-1">Parcela <i id="groupby-plot-icon" style="visibility: hidden; margin-left: 10px; color: #008577" class="fas fa-check-circle"></i></a>
                  </li>
                  <li class="divider"><hr style="height: 1px; margin: 0; padding: 0"></li>
                  <li id="groupby-technician" onclick="updateList(this.id)" style="padding: 8px 8px 8px 24px">
                    <a>Técnico <i id="groupby-technician-icon"style="margin-left: 10px; color: #008577" class="fas fa-check-circle"></i></a>
                  </li>
                  <li class="divider"><hr style="height: 1px; margin: 0; padding: 0"></li>
                  <li id="groupby-none" onclick="updateList(this.id)" style="padding: 8px 8px 8px 24px">
                    <a>Nenhum <i id="groupby-none-icon"style="visibility: hidden; margin-left: 10px; color: #008577" class="fas fa-check-circle"></i></a>
                  </li>
                </ul>
              </li>
              <li class="divider"><hr style="height: 1px; margin: -1px; padding: 0"></li>
              <li class="dropdown-submenu" style="">
                <a tabindex="-1">Ordenar por</a>
                <ul class="dropdown-menu" role="menu" style="margin-left:1px; margin-top: -1px">
                  <li id="orderby-date" onclick="updateList(this.id)" style="padding: 8px 8px 8px 24px">
                    <a tabindex="-1">Data <i id="orderby-date-icon" style="margin-left: 50px; color: #008577" class="fas fa-sort-amount-down"></i></a>
                  </li>
                  <li class="divider"><hr style="height: 1px; margin: 0; padding: 0"></li>
                  <li id="orderby-name" onclick="updateList(this.id)" style="padding: 8px 8px 8px 24px">
                    <a>Nome <i id="orderby-name-icon" style=" visibility: hidden; margin-left: 50px; color: #008577" class="fas fa-sort-amount-up"></i></a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="renderList" style="display: flex; flex-direction: column"></div>

    </div>

    <script type="text/javascript">

      var fontFamily = '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,' +
              '"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"';

      var currentOrder = "orderby-date";
      var orderDirection = 1; //1 = descending ; 0 = asccending
      var currentGrouping = "groupby-technician";

      // Client ID and API key from the Developer Console
      var CLIENT_ID = '697021054229-c7jjbfpfmjkrnoqjo2pg7nfj7v1a1f95.apps.googleusercontent.com';
      var API_KEY = 'AIzaSyCMSb0abab-1ALwctezS4mWo8AalLXI9KI';
      /** LOCALHOST ONLY **/

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = 'https://www.googleapis.com/auth/drive';

      var loginForm = document.getElementById('login');
      var authorizeButton = document.getElementById('authorize_button');
      var userName = document.getElementById('user_name');
      var signoutButton = document.getElementById('signout_button');
      var content = document.getElementById('content');

      var users = [];
      var visits = [];
      var plots = [];

      var lastDevice;
      var fullName;

      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        sessionStorage.clear();
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);


          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        }, function(error) {
          appendPre(JSON.stringify(error, null, 2));
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {

          var currentUser = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
          fullName = currentUser.getName();
          
          authorizeButton.style.display = 'none';
          loginForm.style.display = 'none';
          signoutButton.style.display = 'inline-block';
          userName.innerHTML = fullName;
          userName.style.display = 'inline-block';

          content.style.display = 'flex';
          listUsers();
        } else {
          authorizeButton.style.display = 'inline-block';
          loginForm.style.display = 'flex';
          userName.innerText ="";
          userName.style.display = 'none';
          signoutButton.style.display = 'none';
          content.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();

      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
		document.getElementById("renderList").innerHTML = "";
		document.getElementById('visits').innerHTML = "";
        document.getElementById('visits').removeChild('h3');
		visits = [];
		plots = [];
      }

      /**
       * Append a pre element to the body containing the given message
       * as its text node. Used to display the results of the API call.
       *
       * @param {string} message Text to be placed in pre element.
       */
      function appendPre(message) {
        var pre = document.getElementById('visits');
        var textContent = document.createElement('h3');
        textContent.innerText = message + '\n';
        textContent.style.fontFamily = fontFamily;
        pre.appendChild(textContent);
      }

      function listUsers() {
        var fileID = '1RgkniTJ-VtkilglCzo8dAqALLIgFffWg';
        gapi.client.drive.files.list({
          'folderId' : fileID,
          'pageSize': 100,
          'fields': "nextPageToken, files(id, name, owners)",
          'q': `'${fileID}' in parents`
        }).then(function(response) {
          var files = response.result.files;
          //Everything is loaded

          files.forEach(setUsers);
        });
      }

      function listVisits(fileID, user) {
        if(visits.length === 0)
          appendPre('Visitas de Campo:');
        gapi.client.drive.files.list({
          'folderId' : fileID,
          'pageSize': 100,
          'fields': "nextPageToken, files(id, name, owners)",
          'q': `'${fileID}' in parents`
        }).then(function(response) {
          var files = response.result.files;
          //Everything is loaded

          for(var i = 0; i < files.length; i++){
            if(files[i].name === "info.csv"){
              gapi.client.drive.files.get({
                'fileId': files[i].id,
                'alt': 'media',
              }).then(function(response) {
                var file = response.body;
                var lines = file.split(/\r\n|\n/);
                var headers = lines[0].split(',');
                var userVisits = [];
                for(var i = 1; i < lines.length; i++){
                  var currentLine = lines[i].split(',');
                  var info = [];
                  info.push({user: user});
                  for(var j=0; j < headers.length; j++) {
                    info.push({[headers[j]]:currentLine[j]});
                  }
                  info = info.reduce(((r, c) => Object.assign(r, c)), {});

                  if(!plots.includes(info.plot))
                    plots.push(info.plot);

                  userVisits.push(info);
                  visits.push(info);
                }
                console.log(visits);

                var div = document.getElementById('renderList');
                var visitsDiv = document.createElement('div');
                visitsDiv.style.display = "flex";
                visitsDiv.style.flexDirection = "row";
                visitsDiv.style.flexWrap = "wrap";
                visitsDiv.style.justifyContent = "flex-start";
                visitsDiv.style.alignItems = "flex-start";
                visitsDiv.style.width = "100%";
                div.appendChild(visitsDiv);
                render(visitsDiv, userVisits);
                updateList(currentGrouping);
              });
            }
          }

        });
      }

      function setUsers(element, index, arr) {
        if(element != null){
          if (element.name === "mas.correia@campus.fct.unl.pt") { /** Testing Device */
            users.push({id: element.id, name: element.name, username : element.owners[0].displayName});
            console.log(users);
            listVisits(element.id, element.id);
          }
        }
      }

      function updateList(id) {
        var div = document.getElementById('renderList');
        div.innerHTML = "";

        if (visits.length === 0){
          var noVisits = document.createElement('div');
          noVisits.innerHTML = "Sem Visitas";
          div.appendChild(noVisits);
          return;
        }

        if(id.includes("groupby")){
          document.getElementById(currentGrouping + "-icon").style.visibility = "hidden";
          document.getElementById(id + "-icon").style.visibility = "visible";
          currentGrouping = id;
        }

        var filtered = visits;

        function updateSort() {
          switch (id) {
            case "orderby-date":
              if ((currentOrder === id && orderDirection === 0) || currentOrder !== id) {
                orderDirection = 1;
                document.getElementById(id + "-icon").setAttribute("class", "fas fa-sort-amount-down");
              } else{
                orderDirection = 0;
                document.getElementById(id + "-icon").setAttribute("class", "fas fa-sort-amount-up");
              }
              break;
            case "orderby-name":
              if ((currentOrder === id && orderDirection === 1) || currentOrder !== id) {
                orderDirection = 0;
                document.getElementById(id + "-icon").setAttribute("class", "fas fa-sort-amount-up");
              } else {
                orderDirection = 1;
                document.getElementById(id + "-icon").setAttribute("class", "fas fa-sort-amount-down");
              }
              break;
          }
          document.getElementById(currentOrder + "-icon").style.visibility = "hidden";
          document.getElementById(id + "-icon").style.visibility = "visible";
          currentOrder = id;
        }

        switch (currentGrouping) {
          case "groupby-technician":
            for(var i=0; i< users.length; i++){
              filtered = visits.filter(value => value.user === users[i].id);
              filtered = sort(id, filtered);
              if(filtered.length > 0) {
                var techName = document.createElement('h5');
                techName.innerText = users[i].name + '\n';
                techName.style.fontFamily = fontFamily;
                div.appendChild(techName);
                var techDiv = document.createElement('div');
                techDiv.style.display = "flex";
                techDiv.style.flexDirection = "row";
                techDiv.style.flexWrap = "wrap";
                techDiv.style.justifyContent = "flex-start";
                techDiv.style.alignItems = "flex-start";
                techDiv.style.width = "100%";
                div.appendChild(techDiv);
                render(techDiv, filtered);
              }
            }
            if(!id.includes("groupby"))
              updateSort();
            break;
          case "groupby-plot":
            for(var i=0; i< plots.length; i++){
              plots = plots.sort(function (a, b) {
                return ((a < b) ? -1 : ((a > b) ? 1 : 0));
              });
              filtered = visits.filter(value => value.plot === plots[i]);
              filtered = sort(id, filtered);
              var plotTitle = document.createElement('h5');
              plotTitle.innerText = plots[i] + '\n';
              plotTitle.style.fontFamily = fontFamily;
              div.appendChild(plotTitle);
              var plotDiv = document.createElement('div');
              plotDiv.style.display = "flex";
              plotDiv.style.flexDirection = "row";
              plotDiv.style.flexWrap = "wrap";
              plotDiv.style.justifyContent = "flex-start";
              plotDiv.style.alignItems = "flex-start";
              plotDiv.style.width = "100%";
              div.append(plotDiv);
              render(plotDiv, filtered);
            }
            if(!id.includes("groupby"))
              updateSort();
            break;
          case "groupby-none":
          default:
            var divElement = document.createElement('div');
            divElement.style.display = "flex";
            divElement.style.flexDirection = "row";
            divElement.style.flexWrap = "wrap";
            divElement.style.justifyContent = "flex-start";
            divElement.style.alignItems = "flex-start";
            divElement.style.width = "100%";
            div.append(divElement);
            filtered = sort(id, visits);
            render(divElement, filtered);

            if(!id.includes("groupby"))
              updateSort();
            break;
        }
      }

      function sort(id, visits) {
        var type;
        if(id.includes("groupby"))
          type = currentOrder.split("-")[1];
        else
          type = id.split("-")[1];

        switch (type) {
              case "date":
                if(id.includes("groupby")){
                  visits = orderDirection === 0 ? sortByDateDesc(visits) : sortByDateAsc(visits);
                } else if((currentOrder === id && orderDirection === 0) || currentOrder !== id) {
                  visits = sortByDateAsc(visits);
                } else{
                  visits = sortByDateDesc(visits);
                }
                function sortByDateAsc(visits) {
                visits.sort(function (a, b) { //sort by name asc
                    return ((a.date < b.date) ? 1 : ((a.date > b.date) ? -1 : 0));
                });
                return visits;
              }
                function sortByDateDesc(visits) {
                visits.sort(function (a, b) { //sort by name desc
                    return ((a.date < b.date) ? -1 : ((a.date > b.date) ? 1 : 0));
                });
                return visits;
              }
                break;
              case "name":
                if(id.includes("groupby")) {
                  visits = orderDirection === 0 ? sortByNameAsc(visits) : sortByNameDesc(visits);
                } else if((currentOrder === id && orderDirection === 1) || currentOrder !== id) {
                  visits = sortByNameAsc(visits);
                }else{
                  visits = sortByNameDesc(visits);
                }
                function sortByNameAsc(visits) {
                  visits.sort(function (a, b) { //sort by name asc
                      return ((a.plot < b.plot) ? -1 : ((a.plot > b.plot) ? 1 : 0));
                  });
                  return visits;
                }
                function sortByNameDesc(visits) {
                  visits.sort(function (a, b) { //sort by name desc
                      return ((a.plot < b.plot) ? 1 : ((a.plot > b.plot) ? -1 : 0));
                  });
                  return visits;
                }
                break;
        }
        return visits;
      }

      function render(div, list) {
        for(var i=0; i<list.length; i++) {
          var box = document.createElement('div');
          box.setAttribute('class', 'grid');
          box.setAttribute('id', list[i]['fileId']);
          box.onclick = function () {
            var value = JSON.stringify(visits.find(value => value.id = this.id));
            sessionStorage.setItem('visit', value);
            window.location.href = 'visit.html?visit_id=' + this.id;
          };
          var title = document.createElement('a');
          console.log(list[i]);
          var topIcon = list[i].rain === "true" ? '&ensp;&thinsp;<img src="resources/images/rain_icon.png" style="width:30px;height:30px">'
                  : list[i].treatment === "true" ? '&ensp;&ensp;<img src="resources/images/treatment_icon.png" style="width:30px;height:30px">' : '';
          title.innerHTML = list[i].plot + '&emsp;&ensp;' + refactorDate(list[i].date) + topIcon;
          title.style.borderBottom = "1px solid grey";
          title.style.fontSize = "18px";
          title.style.color = "#008577";
          title.style.fontWeight = "bold";
          title.style.lineHeight = 'unset';
          title.style.height = "35px";
          title.style.paddingBottom = "8px";
          title.style.marginBottom = "12px";
          title.style.alignSelf = "center";
          title.style.width = "165px";
          var ef_nea = document.createElement('a');
          var ef = list[i].ef;
          if(list[i].ef === "null")
            ef = "--";
          if(list[i].nea === "null")
            ef_nea.innerHTML = "<b>EF: </b>" + ef;
          else
            ef_nea.innerHTML = "<b>EF: </b>" + ef + "\t" + "<b>NEA: </b>" + list[i].nea;
          ef_nea.style.marginBottom = '8px';
          var content = document.createElement('a');

          var notestr = list[i].notes;
          if(list[i].notes === "null")
            notestr = '&nbsp;';

          var overall = list[i].overall;
          if(list[i].overall === "null")
            overall = '&nbsp;';

          if(list[i].visited === "false") {
            overall = "Visita não efetuada";
            if(list[i].notes === "null") {
              content.innerHTML = '<p style="margin-bottom: 5px">' + overall + '</p>';
              content.style.lineHeight = "3";
            }else
              content.innerHTML = '<p style="margin-bottom: 5px">' + overall + '</p>' + '<p style="margin-bottom: 0">' + notestr + '</p>';
          }else if(list[i].notes === "null"){
            content.innerHTML = '<p style=" height: 50px; align-content: center; margin-bottom: 0">' + overall + '</p>';
            content.style.lineHeight = "3";
          }else
            content.innerHTML = '<p style="margin-bottom: 5px">' + notestr + '</p>' + '<p style="margin-bottom: 0">' + overall + '</p>';

          content.style.alignSelf = "center";
          content.style.textAlign = "center";
          content.style.justifySelf = "center";
          content.style.marginBottom = "18px";
          content.style.fontSize = "16px";
          var multimedia = document.createElement('a');
          var photos = '<i class="fas fa-camera" style="font-size: 20px; color: #008577"/>' +
                  '<a style="font-size: 14px; font-family: sans-serif; font-weight: normal">' + " " + list[i].numPhotos + '</a>';
          var audio = '<i class="fas fa-microphone" style="padding-left: 12px; font-size: 20px; color: #008577"/>' +
                  '<a style="font-size: 14px; font-family: sans-serif; font-weight: normal;">' + " " + list[i].numVoice + '</a>';
          var gpsIcon = list[i].gps === "false" ? '&ensp;&ensp;<img src="resources/images/no_gps_icon.png" style="width:30px;height:30px">' :
                  '&ensp;&ensp;&ensp;&ensp;';
          var user = users.find(value => value.id === list[i].user);
          var userNames = user.username.split(" ");
          var userPhoto = '<a id="user_icon" style="color: dimgrey; font-weight: bolder; font-family:sans-serif; font-size: 14px; width: 30px; height: 30px; line-height: unset;' +
                  '-webkit-border-radius: 25px; -moz-border-radius: 25px; border-radius: 25px; padding-top:5px;padding-bottom:5px; padding-left:3px; padding-right:3px; background-color: white">'
                  + userNames[0].substr(0,1).toUpperCase() + userNames[userNames.length-1].substr(0,1).toUpperCase() + '</a>';
          var userIcon = list[i].technicians.split("|").length === 1 ? '&thinsp;&ensp;' + userPhoto :
                  '&ensp;&ensp;<img src="resources/images/coop_icon.png" style="width:30px;height:30px">';
          multimedia.innerHTML = photos + audio + gpsIcon + userIcon;
          multimedia.style.alignSelf = "left";
          multimedia.style.color = "#008577";
          box.appendChild(title);
          box.appendChild(ef_nea);
          box.appendChild(content);
          box.appendChild(multimedia);

          //li.onclick = function(){onDeviceClick(this.getAttribute('id'))};

          div.appendChild(box);

          //li.innerHTML=li.innerHTML + element.name;
        }
      }

      function refactorDate(date) {
        var values = date.split('/');
        var month = "";
        switch (values[1]) { //get month
          case '01':
            month = " Jan ";
            break;
          case '02':
            month = " Fev ";
            break;
          case '03':
            month = " Mar ";
            break;
          case '04':
            month = " Abr ";
            break;
          case '05':
            month = " Mai ";
            break;
          case '06':
            month = " Jun ";
            break;
          case '07':
            month = " Jul ";
            break;
          case '08':
            month = " Ago ";
            break;
          case '09':
            month = " Set ";
            break;
          case '10':
            month = " Out ";
            break;
          case '11':
            month = " Nov ";
            break;
          case '12':
            month = " Dez ";
            break;
        }
        return values[2] + month /*+ values[0].substr(2)*/;
      }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>








<!--<DOCTYPE! html>

<html>

<head>

	<style>
      #map {
        width: 100%;
        height: 400px;
        background-color: grey;
      }
    </style>
	
	<script src="js/javascript.js"></script>

</head>

<body>



    <h3>My Google Maps Demo</h3>
    <div id="map"></div>
	<script language="javascript">
		initMap();
	</script>
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
    </script>

</body>


</html>-->
