<DOCTYPE! html>

<html>

<head>
<meta charset=utf-8 />
<title>Informação da visita</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

<script src='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.css' rel='stylesheet' />

<script src="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.css" rel="stylesheet" />

<style>
  body { margin:0; padding:0; }
  
  #map { position:absolute; height: 100%; top:0; bottom:0; width:49%; }
  
  #info {position:absolute; height: 100%; top:0px; bottom:0; left:0px; width:100%; visibility: hidden;}
  
  .column {
	  float: left;
	  width: 50%;

  }
  
 .image_thumbnail {height: 150px; width:150px; margin:15px;}

 .row:after {
	  content: "";
	  display: table;
	  clear: both;
 }
 
 #menu {
	position: relative;
	background: #fff;
	padding: 10px;
	font-family: 'Open Sans', sans-serif;

	}
	
 .gallery {
	display: none;
  }
	
.marker_image {
  background-image: url('resources/images/blue_marker_photo.png');
  background-size: cover;
  width: 150px;
  height: 150px;
  border-radius: 50%;
  cursor: pointer;
}

.marker_voice {
  background-image: url('resources/images/blue_marker_mic.png');
  background-size: cover;
  width: 150px;
  height: 150px;
  border-radius: 50%;
  cursor: pointer;
}

.mapboxgl-popup {
  max-width: 200px;
}

.mapboxgl-popup-content {
  text-align: center;
  font-family: 'Open Sans', sans-serif;
}

</style>

</head>

<body>




		

	
	
	<div id="info">
		
		<div class="row">
		
			<div class="column">
				
				<div id="map"></div>
				<div id="menu">
					<input
						id="streets-v11"
						type="radio"
						name="rtoggle"
						value="streets"
						checked="checked"/>
					<label for="streets">streets</label>
					<input id="light-v10" type="radio" name="rtoggle" value="light" />
					<label for="light">light</label>
					<input id="dark-v10" type="radio" name="rtoggle" value="dark" />
					<label for="dark">dark</label>
					<input id="outdoors-v11" type="radio" name="rtoggle" value="outdoors" />
					<label for="outdoors">outdoors</label>
					<input id="satellite-v9" type="radio" name="rtoggle" value="satellite" />
					<label for="satellite">satellite</label>
				</div>
			</div>
			
			<div class="column" style="overflow-y: scroll; height:100%;">
					<h1 id="plot_name" ></h1>
					
					<br>

						
					<a id="number_photos_text" size="6">Fotografias: </a>
					<a id="number_photos"></a>

					<br>
					<br>
					
					<a id="number_voice_records_text" size="6">Anotações vocais:</a>
					<a id="number_voice_records" ></a>

					<br>
					<br>
					
					<a id="begin_text" size="6">Início:</a>
					<a id="begin"></a>

					<br>
					<br>
					
					<a id="duration_text">Duração:</a>
					<a id="duration"></a>
					
					<br>
					<br>
					
					<div id='notes'>
						<h3> Adicionar nota </h3>
						<textarea id="note" rows="4" cols="50"></textarea>		
						<button id="add_note">Enviar</button>
					</div>
					<br>
					
					<div  id="note_gallery">
						<h3> Notas </h3>
						<a id="no_notes"> Sem notas. </a>
						<ul id= "notes_ul"/>
					</div>
					
					<br>

					<div  class="gallery" id="photo_gallery" >
						<h3> Fotografias </h3>
					</div>
					
					<br>

					<div  class="gallery" id="audio_gallery">
						<h3> Áudios </h3>
					</div>

												
			</div>

		</div>
		



	</div>
	
	
	



	<script type='text/javascript'>
	
		
		mapboxgl.accessToken = 'pk.eyJ1IjoibWlndWVsYXNjb3JyZWlhIiwiYSI6ImNrN25iYzh4NTAxMHIzc210bzJpM3EyZDcifQ.pVWzek_lEMfJixSnBu1ZMA';
	
      		var CLIENT_ID = '697021054229-c7jjbfpfmjkrnoqjo2pg7nfj7v1a1f95.apps.googleusercontent.com';
      		var API_KEY = 'AIzaSyCMSb0abab-1ALwctezS4mWo8AalLXI9KI';

		  var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
		  var SCOPES = 'https://www.googleapis.com/auth/drive';
		  
		  var mFocus;
		  var mPoints;
		  var mPlot;
		  var noteFolder = '';
		  var imageFolder = '';
		  var audioFolder = '';
		  var userName = '';
		  
		  var files_map = {};
		  
		  var map = new mapboxgl.Map({
				container: 'map',
				style: 'mapbox://styles/mapbox/streets-v11',
				zoom: 0
			});

		
		var layerList = document.getElementById('menu');
		var inputs = layerList.getElementsByTagName('input');
		 
		function switchLayer(layer) {
			var layerId = layer.target.id;
			map.setStyle('mapbox://styles/mapbox/' + layerId);
			 map.on('style.load', function() {
				reloadMap();


			});
		}
		 
		for (var i = 0; i < inputs.length; i++) {
			inputs[i].onclick = switchLayer;
		}
		
		
		
		var input = document.getElementById('note');
		var button = document.getElementById('add_note');
		
		button.onclick = function(){
			var text = input.value;
			if(text == null || text == "")
				alert("Campo obrigatório");
			else{
				
				function pad2(n) { return n < 10 ? '0' + n : n }

				var date = new Date();

				var name = date.getFullYear().toString() + pad2(date.getMonth() + 1) + pad2( date.getDate()) + pad2( date.getHours() ) + pad2( date.getMinutes() ) + pad2( date.getSeconds() );
					   
				text = userName + " ("+ pad2( date.getDate()) + "/" + pad2(date.getMonth() + 1) + "/" +  date.getFullYear().toString() + " " + pad2( date.getHours() )+ ":" + pad2( date.getMinutes() ) + '): ' + text;

								
				var file = new Blob([text], {type: 'text/plain'});
				
				var accessToken = gapi.auth.getToken().access_token;
				
				var form = new FormData();


				if(noteFolder == ''){
					var folderId = getUrlVars()['visit_id'];


				   var request = gapi.client.drive.files.create({
						   "name" : "Notes",
						   "mimeType" : "application/vnd.google-apps.folder",
						   "parents" : [folderId],
					   });
					   
				   request.execute(function(resp) { 
					   noteFolder = resp.id;
					   
						var metadata = {
								"name" : name,
								"mimeType" : "text/plain",
								"parents" : [noteFolder],
						};

						form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
						form.append('file', file);

						var xhr = new XMLHttpRequest();
						xhr.open('post', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id');
						xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
						xhr.responseType = 'json';
						xhr.onload = () => {
							var a = document.getElementById("no_notes");
							a.innerHTML = "";
							var ul = document.getElementById("notes_ul");
							var li = document.createElement('li');
							ul.appendChild(li);
							li.innerHTML=li.innerHTML + text;
						};
						xhr.send(form);
								 
				   });
				}else{
					var metadata = {
							"name" : name,
							"mimeType" : "text/plain",
							"parents" : [noteFolder],
					};

					form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
					form.append('file', file);

					var xhr = new XMLHttpRequest();
					xhr.open('post', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id');
					xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
					xhr.responseType = 'json';
					xhr.onload = () => {
						var a = document.getElementById("no_notes");
						a.innerHTML = "";					
						var ul = document.getElementById("notes_ul");
						var li = document.createElement('li');
						ul.appendChild(li);
						li.innerHTML=li.innerHTML + text;
					};
					xhr.send(form);
				}
				
				input.value = '';
			}
		}
		
		
		
		function reloadMap(){
		
		if(map.getLayer('plot'))
			map.removeLayer('plot')
			
		if(map.getLayer('route'))
			map.removeLayer('route')
		
		
		if(!map.getSource('plot'))
			map.addSource('plot', {
				'type': 'geojson',
				'data': {
					'type': 'Feature',
					'geometry': {
					'type': 'Polygon',
					'coordinates': mPlot
					}
				}
			});
			
		if(!map.getSource('route'))

			map.addSource('route', {
				'type': 'geojson',
				'data': {
				'type': 'Feature',
				'properties': {},
				'geometry': {
				'type': 'LineString',
				'coordinates': mPoints
				}
				}
			});
		
			map.addLayer({
				'id': 'plot',
				'type': 'fill',
				'source': 'plot',
				'layout': {},
				'paint': {
					'fill-color': '#55C93D',
					'fill-opacity': 0.4
				}
			});
			
			map.addLayer({
				'id': 'route',
				'type': 'line',
				'source': 'route',
				'layout': {
					'line-join': 'round',
					'line-cap': 'round'
					},
				'paint': {
					'line-color': '#e55e5e',
					'line-width': 6
				}
			});
		}
		


		  		
		function readTextFile(file, callback) {
			var rawFile = new XMLHttpRequest();
			rawFile.overrideMimeType("application/json");
			rawFile.open("GET", file, true);
			rawFile.onreadystatechange = function() {
				if (rawFile.readyState === 4 && rawFile.status == "200") {
					callback(rawFile.responseText);
				}
			}
			rawFile.send(null);
		}
		
		
		  function handleClientLoad() {
			gapi.load('client:auth2', initClient);
		  }

		
		  function initClient() {
			gapi.client.init({
			  apiKey: API_KEY,
			  clientId: CLIENT_ID,
			  discoveryDocs: DISCOVERY_DOCS,
			  scope: SCOPES
			}).then(function () {
			  // Listen for sign-in state changes.
			  gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

			  // Handle the initial sign-in state.
			  updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
			}, function(error) {
			  appendPre(JSON.stringify(error, null, 2));
			});
		  }
		  
		  function updateSigninStatus(isSignedIn) {
		    auth2 = gapi.auth2.getAuthInstance();
			if (isSignedIn) {
				var profile = auth2.currentUser.get().getBasicProfile();
				userName = profile.getName();
			 listFolder();
			}
		  }
		  
//		  function appendPre(message) {
//			var pre = document.getElementById('content');
//			var textContent = document.createTextNode(message + '\n');
//			pre.appendChild(textContent);
//		  }
		  
		function getUrlVars() {
			var vars = {};
			var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
				vars[key] = value;
			});
			return vars;
		}
		
		function loadMap(toFocus,plot){
				this.mFocus = toFocus;
				this.mPlot = plot;
		
				map.flyTo({ center: toFocus, zoom: 16, speed: 10. });
				
				var layers = map.getStyle().layers;

				var found = false;
				var layerIds = layers.map(function (layer) {
					if(layer.id == 'route')
					found = true;
				});
				
				
				map.addSource('plot', {
					'type': 'geojson',
					'data': {
						'type': 'Feature',
						'geometry': {
						'type': 'Polygon',
						'coordinates': plot
						}
					}
				});
				if(found)
					map.addLayer({
						'id': 'plot',
						'type': 'fill',
						'source': 'plot',
						'layout': {},
						'paint': {
							'fill-color': '#55C93D',
							'fill-opacity': 0.4
						}
					},'route');
				else					
				
					map.addLayer({
						'id': 'plot',
						'type': 'fill',
						'source': 'plot',
						'layout': {},
						'paint': {
							'fill-color': '#55C93D',
							'fill-opacity': 0.4
						}
					});

		}
		
		
		function addRoute(points, wayPoints){
			this.mPoints = points;

			for(var i = 0 ; i < wayPoints.length; i++){
				var el = document.createElement('div');
				var popup;

				if(wayPoints[i][0].type > 0){
					el.className = 'marker_voice';
					popup = new mapboxgl.Popup({ offset: 25 }) 
							.setHTML('<a href="https://drive.google.com/uc?export=view&id=' + files_map[wayPoints[i][0].name] +'" target=' + wayPoints[i][0].name + '>' + wayPoints[i][0].name + '</a>');
					}
				else{
					el.className = 'marker_image';
					popup = new mapboxgl.Popup({ offset: 25 }) 
							.setHTML('<a href="https://drive.google.com/uc?export=view&id=' + files_map[wayPoints[i][0].name] + '" target=' + wayPoints[i][0].name + '>' + wayPoints[i][0].name + '</a>');
					}
					
					
				var point = [wayPoints[i][0].longitude, wayPoints[i][0].latitude];

				  new mapboxgl.Marker(el)
					.setLngLat(point)
					.setPopup(popup)
					.addTo(map);
			
			}


				map.addSource('route', {
				'type': 'geojson',
				'data': {
				'type': 'Feature',
				'properties': {},
				'geometry': {
				'type': 'LineString',
				'coordinates': points
				}
				}
				});
				map.addLayer({
					'id': 'route',
					'type': 'line',
					'source': 'route',
					'layout': {
						'line-join': 'round',
						'line-cap': 'round'
						},
					'paint': {
						'line-color': '#e55e5e',
						'line-width': 6
					}
				});
		}
		
		function msToTime(s) {

		  function pad(n, z) {
			z = z || 2;
			return ('00' + n).slice(-z);
		  }

		  var ms = s % 1000;
		  s = (s - ms) / 1000;
		  var secs = s % 60;
		  s = (s - secs) / 60;
		  var mins = s % 60;
		  var hrs = (s - mins) / 60;

		  return pad(hrs) + ':' + pad(mins) + ':' + pad(secs);
		}
		
		
		
		function getGPX(id){
			gapi.client.drive.files.get({
				'fileId': id,
				'alt': 'media',
			}).then(function(response) {
								var gpx = response.body;
					var trk = gpx.substring(
								gpx.lastIndexOf("<trkseg>") + 8, 
								gpx.lastIndexOf("</trkseg>")
							);
					
							
					
					var arrayOfLines = trk.match(/[^\r\n]+/g);
					var points = [];
					
					for(var w = 0; w < arrayOfLines.length; w++){
						var line = arrayOfLines[w];
						var lat = line.substring(
								line.lastIndexOf('<trkpt lat="') + 12, 
								line.lastIndexOf('" lon="')
							);
						var ln = line.substring(
								line.lastIndexOf('lon="') + 5, 
								line.lastIndexOf('"><time>')
							);
							
						var point = [];
						point.push(parseFloat(ln));
						point.push(parseFloat(lat));
						points.push(point);
							
					}
					
					var wayPoints = [];
					
					var wpts  = gpx.substring(
									gpx.indexOf("<wpt "), 
									gpx.lastIndexOf("</wpt>")
								);
					var wpts_array = wpts.split("<wpt ");
					for(var k = 0 ; k < wpts_array.length ;k ++){
						var line = wpts_array[k];
						if(line != ""){
							var file_name = line.substring(
									line.lastIndexOf('<name>') + 6, 
									line.lastIndexOf('</name>')
								);
							var lat = line.substring(
									line.lastIndexOf('lat="') + 5, 
									line.lastIndexOf('" lon="')
								);
							var ln = line.substring(
									line.lastIndexOf('lon="') + 5, 
									line.lastIndexOf('"><time>')
								);
								
							var waypoint = [];
							var file_type;
							if(file_name.includes("photo"))
									file_type = 0;
							else
									file_type = 1;

							var file = {type:file_type, name:file_name, longitude:parseFloat(ln), latitude:parseFloat(lat)};

							waypoint.push(file);
							wayPoints.push(waypoint);
						}
							
							
					}
					
					addRoute(points,wayPoints);	
			
			
			});
		}

		function getVisitJSON(id){
			gapi.client.drive.files.get({
				'fileId': id,
				'alt': 'media',
			}).then(function(response) {
					var json =  JSON.parse(response.body); //response.body contains the string value of the file
					var plot_id = json['plot_id'];
					var plots_jsons;
					readTextFile("resources/json/parcelas.json", function(text){
						plots_jsons = JSON.parse(text);
						
						for(var j = 0; j < plots_jsons.features.length; j++){
							var idparcela = plots_jsons.features[j].properties['idparcela'];
							if(idparcela == plot_id){
								
							
								document.getElementById('plot_name').innerHTML = plots_jsons.features[j].properties['nomeparcela'];
								
								document.getElementById('number_photos').innerHTML = json['number_photos'];
								
								document.getElementById('number_voice_records').innerHTML = json['number_voice_records'];
								
								var begin = json['time_begin'].replace('_','');
								var end = json['time_end'].replace('_','');
								
								var year = begin.substring(0,4);
								var month = begin.substring(4,6);
								var day = begin.substring(6,8);
								var hour = begin.substring(8,10);
								var min = begin.substring(10,12);
								
								document.getElementById('begin').innerHTML = day +'/' + month + '/' + year + ' ' + hour + ':' + min
								
								
								
								var begin_date = new Date(begin.replace(
									/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)$/,
									'$4:$5:$6 $2/$3/$1'
								));
								
								var end_date = new Date(end.replace(
									/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)$/,
									'$4:$5:$6 $2/$3/$1'
								));
								
								var difference = end_date - begin_date;
								
								document.getElementById('duration').innerHTML = msToTime(difference);
								
								document.getElementById("info").style.visibility = "visible";
								
								var coordinates =  plots_jsons.features[j].geometry.coordinates;
								var toFocus = coordinates[0][0];
								loadMap(toFocus, coordinates);
								break;
							}
						}
						//data.features[0].geometry
					});

			});	
		}
		
		
		function getPhotos(id){
			gapi.client.drive.files.list({
			  'folderId' : id,
			  'pageSize': 100,
			  'fields': "nextPageToken, files(id, name)",
			  'q': `'${id}' in parents`
			}).then(function(response) {
			  var files = response.result.files;
			  if (files && files.length > 0) {
					var div = document.getElementById("photo_gallery");
				  	div.style.display = "block"
					for(var i = 0; i < files.length; i++){
					
						files_map[files[i].name] = files[i].id;
						
					/*	gapi.client.drive.files.get({
							'fileId': files[i].id,
							'alt': 'media',
						}).then(function(response) {
							var b64Response = btoa(response.body);

							var outputImg = document.createElement('img');
							outputImg.src = 'data:image/png;base64,'+b64Response;

							document.body.appendChild(outputImg);
						});*/
						
						var name = files[i].name.substring(6,files[i].name.length).replace('_','');
						
						var year = name.substring(0,4);
						var month = name.substring(4,6);
						var day = name.substring(6,8);
						var hour = name.substring(8,10);
						var min = name.substring(10,12);
						
												
						var title = day + "/" + month + "/" + year + " " + hour + ":" + min;

						var image_container = document.createElement('a');
						image_container.href = 'https://drive.google.com/uc?export=view&id=' + files[i].id;
						image_container.target = files[i].name;
						image_container.rel = "noopener nore";
						var img = document.createElement('img');
						img.src = 'https://drive.google.com/uc?export=view&id=' + files[i].id;
						img.setAttribute( "class", 'image_thumbnail');

						var figcaption = document.createElement('figcaption');
						figcaption.setAttribute( "class", 'image_caption');
						figcaption.innerHTML = title;
						
						var figure = document.createElement('figure');
						figure.appendChild(img);
						figure.appendChild(figcaption);
						
						image_container.appendChild(img);
						div.appendChild(image_container);
					}
				}
			
			});
		}
		
		function getAudios(id){
			gapi.client.drive.files.list({
			  'folderId' : id,
			  'pageSize': 100,
			  'fields': "nextPageToken, files(id, name)",
			  'q': `'${id}' in parents`
			}).then(function(response) {
			  var files = response.result.files;
			  if (files && files.length > 0) {
					var div = document.getElementById("audio_gallery");
					
				  	div.style.display = "block"

					for(var i = 0; i < files.length; i++){
					   files_map[files[i].name] = files[i].id;

					/*	gapi.client.drive.files.get({
							'fileId': files[i].id,
							'alt': 'media',
						}).then(function(response) {
							var b64Response = btoa(response.body);

							var outputImg = document.createElement('img');
							outputImg.src = 'data:image/png;base64,'+b64Response;

							document.body.appendChild(outputImg);
						});*/
						
						var a = document.createElement('a');
						var br1 = document.createElement('br');
						var br2 = document.createElement('br');
						var br3 = document.createElement('br');						
						
						var name = files[i].name.split("_");

						var day = name[name.length -2];
						var year = day.substring(0,4);
						var month  = day.substring(4,6);
						var day_of_month  = day.substring(6,8);

						var time = name[name.length -1];
						var hour = time.substring(0,2);
						var minutes = time.substring(2,4);
						
						a.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;" + day_of_month + "/" + month + "/" + year + " " + hour + ":" + minutes;

						
						var audio = document.createElement('audio');
						audio.id       = 'audio-player';
						audio.controls = 'controls';	
						audio.src      = 'https://drive.google.com/uc?export=download&id=' + files[i].id;
						audio.type     = 'audio/mp3';

						div.appendChild(a);
						div.appendChild(br1);
						div.appendChild(audio);
						div.appendChild(br2);
						div.appendChild(br3);


					}
				}
			
			});
		}
		
		
		
		function getNotes(id){
			gapi.client.drive.files.list({
			  'folderId' : id,
			  'pageSize': 100,
			  'fields': "nextPageToken, files(id, name)",
			  'q': `'${id}' in parents`
			}).then(function(response) {
			  var files = response.result.files;
			  if (files && files.length > 0) {
					var a = document.getElementById("no_notes");
					a.innerHTML = "";
			  		var div = document.getElementById("note_gallery");
				  	var ul = document.getElementById("notes_ul");
					for(var i = 0; i < files.length; i++){
						gapi.client.drive.files.get({
							'fileId': files[i].id,
							'alt': 'media',
						}).then(function(response) {
							var li = document.createElement('li');
							ul.appendChild(li);
							li.innerHTML=li.innerHTML + response.body;
							
						});
					}
				}
			});
		}
		
		
		function listFolder() {
		   var fileId = getUrlVars()['visit_id'];
		   var json_id = '';
		   var gpx_id = '';
		   var photo_id = '';
		   var audio_id = '';

			gapi.client.drive.files.list({
			  'folderId' : fileId,
			  'pageSize': 100,
			  'fields': "nextPageToken, files(id, name)",
			  'q': `'${fileId}' in parents`
			}).then(function(response) {
			  var files = response.result.files;
			  if (files && files.length > 0) {
				for(var i = 0; i < files.length; i++){
				
					var id = files[i].id
					
					if(files[i].name.includes('json')){
						json_id = id;
						//getVisitJSON(id);
					}
				    else if(files[i].name.includes('gpx')){
						gpx_id = id;
						//getGPX(files[i].id);
					}
					else if(files[i].name == 'Photos'){
						photo_id = id;
						//getPhotos(files[i].id);
					}
					else if(files[i].name == 'Audio'){
						audio_id = id;
						//getAudios(files[i].id);

					}
					else if(files[i].name == 'Notes'){
						//getNotes(files[i].id);
						noteFolder = files[i].id;
					}	
				}	  
				if(noteFolder != '')
					getNotes(noteFolder)
				if(photo_id != '')
					getPhotos(photo_id);
				if(audio_id != '')
					getAudios(audio_id);
				if(json_id != '')
					getVisitJSON(json_id);
				if(gpx_id != '')
					getGPX(gpx_id);
					
			  } else {
				appendPre('No files found.');
			  }
			});
		}
		
	</script>  

	<script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
	

</body>


</html>
