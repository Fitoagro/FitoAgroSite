<!DOCTYPE html>

<html>

<head>
	<meta charset=utf-8 />
	<title>Informação da visita</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<script type='text/javascript' src='https://eu-west-1a.online.tableau.com/javascripts/api/viz_v1.js'></script>

	<script src="https://kit.fontawesome.com/16512b04b3.js" crossorigin="anonymous"></script>

	<script src='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.css' rel='stylesheet' />

	<script src="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		  integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

</head>

<body>

<div id="myModal" class="modal">

    <div id="modal_content" class="modal-content">

		<div style="width: 100%">
			<div style="width: 300px; float: left; height: 500px;   display : flex;align-items : center;justify-content: center;background: lightgray" >
				<img id="modal_photo" style="position: relative; display: none; "/>
				<audio id="modal_audio" controls="controls" typeof="audio/mp3" style="position: relative; display: none;"></audio>
			</div>

			<div style="margin-left: 320px">
				<p id="modal_close" onclick="onModalClose()" style="color: gray; font-size:24px; margin-left: 620px; ">x</p>

				<div>

					<svg  id="modal_edit"  onclick="tryEdit()" style="position: relative;float:left;display: none;" width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-pencil-square" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
						<path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
						<path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
					</svg>

					<svg  id="modal_edit_close"  onclick="cancelEdit()" style="position:  relative; float:left; display: none; " width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-x-circle" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
						<path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
						<path fill-rule="evenodd" d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
					</svg>
					<a style="float: left">&ensp;</a>

					<svg  id="modal_edit_confirm"  onclick="confirmEdit()" style="position: relative; float:left; display: none;" width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-check-circle" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
						<path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
						<path fill-rule="evenodd" d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z"/>
					</svg>

					<a style="float: left">&ensp;</a>

					<svg id="modal_locate"  onclick="zoomOnMap()" style="position: relative;display: none; float: left"  width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-map" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
						<path fill-rule="evenodd" d="M15.817.113A.5.5 0 0 1 16 .5v14a.5.5 0 0 1-.402.49l-5 1a.502.502 0 0 1-.196 0L5.5 15.01l-4.902.98A.5.5 0 0 1 0 15.5v-14a.5.5 0 0 1 .402-.49l5-1a.5.5 0 0 1 .196 0L10.5.99l4.902-.98a.5.5 0 0 1 .415.103zM10 1.91l-4-.8v12.98l4 .8V1.91zm1 12.98l4-.8V1.11l-4 .8v12.98zm-6-.8V1.11l-4 .8v12.98l4-.8z"/>
					</svg>

				</div>

				<a id="modal_date" style="position: relative; float: right; color: #00574B; font-size:24px; font-weight: bold; "></a>


				<div style="position: relative; margin-top: 50px;;font-size:20px; text-align: justify;text-justify: inter-word;">

					<p id="modal_description" style="height:75px; overflow: auto; color: black;word-wrap: break-word;  "></p>

					<input id="modal_description_edit"  style="height:75px; width: 100%; color: black; display:none;"/>

					<div>
						<a id="modal_number_comments" style="font-size: 16px; font-weight: bold; float: right">0</a>
						<a style="float: right">&ensp;</a>
						<svg width="1em"  style="position: relative; float: right" height="1em" viewBox="0 0 16 16" class="bi bi-chat-left-text" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
							<path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v11.586l2-2A2 2 0 0 1 4.414 11H14a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
							<path fill-rule="evenodd" d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
						</svg>

					</div>
					<hr style="margin-top: 40px" />

					<div class="comments" id="file_comments">
						<a id="file_no_comments" style="display: block; color: gray; text-align: center;">&ensp;Sem comentários.</a>

					</div>
					<hr />

					<div style="float: left; position:relative;">
						<input id="file_comment_input"  style="color: black; font-size:24px;"/>

						<button onclick="addNewCommentToFile()" style="font-size:24px">Enviar <i class="fa fa-send-o"></i></button>

					</div>

				</div>

			</div>
		</div>


    </div>

</div>


<div id="note_modal" class="modal">

	<div id="note_modal_content" class="modal-content-notes">
		<a id="modal_title" style="position: relative; left: 38%; color: #00574B; font-size:24px; font-weight: bold; text-align: center ">Notas da visita</a>

		<span id="note_modal_close" onclick="document.getElementById('note_modal').style.display = 'none'" style="position: relative; float: right; color: gray; font-size:24px ">x</span>



		<div style="position: relative; margin-top: 50px;font-size:20px; text-align: justify;text-justify: inter-word;">

			<a id="note_modal_description" style="color: black; "></a>
			<br>
			<div style="margin-bottom: 25px">
				<a id="note_modal_number_comments" style="font-size: 16px; font-weight: bold; float: right">0</a>
				<a style="float: right">&ensp;</a>
				<svg width="1em"  style="position: relative; float: right" height="1em" viewBox="0 0 16 16" class="bi bi-chat-left-text" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
					<path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v11.586l2-2A2 2 0 0 1 4.414 11H14a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
					<path fill-rule="evenodd" d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
				</svg>

			</div>
			<hr />

			<div class="comments" id="note_comments">
				<a id="note_no_comments" style="color: gray; text-align: center;">&ensp;Sem comentários.</a>

			</div>
			<hr />

			<div style="float: left; height: 100px; position:relative;">
				<input id="note_comment_input"  style="color: black; font-size:24px;"/>

				<button onclick="addNewCommentToNote()" style="font-size:24px">Enviar <i class="fa fa-send-o"></i></button>

			</div>
			<p>&nbsp;</p>

		</div>
	</div>

</div>

<div class="header">
	<img src="resources/images/fitoagro_logo.png" style="height: 40px; padding-bottom: 4px; align-self: center; margin-right: 64px">
	<div id="visits_tab" onclick="window.location.href = 'index.html'" style="cursor:pointer; margin-right: 20px; padding:6px; font-size: 18px; color: white">Visitas</div>
	<div id="stats_tab" onclick="window.location.href = 'stats.html'" style="cursor:pointer; padding:6px; font-size: 18px; color: white">Estatísticas</div>
	<div style="margin-left: auto; align-self: center">
		<!--Add buttons to initiate auth sequence and sign out-->
		<div id="user_name"  style="font-size: 22px"> </div>
		<button onclick="handleSignoutClick()" type="button" class="btn light-button" style="background-color: lightgray; color: black; display: inline-block; float: right;  " id="signout_button">Logout</button>
	</div>
</div>

<div style="display: flex; flex-direction: row; align-items: center; margin-top: 16px; padding-bottom: 8px; border-bottom: 1px solid lightgrey;
margin-left: 32px; margin-right: 32px">
	<span  id="last_visit_area" style="margin-right:auto; cursor: default">
		<i class="fas fa-chevron-left" style="font-size: 20px;"></i>&emsp;
		<a id="last_visit" style="width: 170px;font-size: 15px;"></a>
	</span>
	<h4 id="plot_name" style="text-align: center; color: #008577; font-weight:bold;"></h4>
	<span id="next_visit_area" style="margin-left: auto; cursor: default">
		<a id="next_visit" style="font-size: 15px; width: 170px; text-align: right"></a>&emsp;
		<i class="fas fa-chevron-right" style="font-size: 20px;"></i>
	</span>
</div>

<div class="content" style="display: flex; margin-left: 2%; margin-right: 2%">
<div id="info" style="display: flex; flex-direction: row;">

	<div style="width: 100%; height: 100%; display: flex; flex-direction: row; flex-wrap:wrap; justify-content: space-between; justify-items: flex-start; padding: 16px 24px 0 20px;">

			<div style="flex-direction: column; min-width: 50%; flex-wrap: wrap; padding-right: 18px">

				<div style="display: flex; flex-direction: row; align-items: baseline">
                    <span id="begin_text" style="width: 13%; font-weight: bold; font-size: 18px; color: black">Início:</span>
					<span style="width: 20%; margin-left: 1%">
						<a id="begin"></a>
					</span>

                    <span id="duration_text" style="width: 13%; font-weight: bold; font-size: 18px; color: black">Duração:</span>
                    <span style="width: 50%; margin-left: 1%">
						<a id="duration" ></a>
					</span>
				</div>

				<div style="display: flex; flex-direction: row; margin-top: 10px; align-items: baseline">
                    <span style="width:13%; font-weight: bold; font-size: 18px; color: black">Técnico:</span>
                    <span style="width: 20%; margin-left: 1%">
						<a id="technician" ></a>
					</span>

                    <span style="width:13%; font-weight: bold; font-size: 18px; color: black">E. F.:</span>
                    <span style="width:20%; margin-left: 1%">
						<a id="ef"></a>
					</span>

                    <span id="nea_text" style="width:13%; font-weight: bold; font-size: 18px; color: black; display: none">NEA:</span>
                    <span style="width: 20%; margin-left: 1%">
						<a id="nea"></a>
					</span>

				</div>


				<div  id="note_gallery" style="display: flex; flex-direction: row; margin-top: 10px; align-items: baseline">
					<span style="width: 13%; font-weight: bold; font-size: 18px; color: black"> Notas: </span>
                    <span style="width: 20%; margin-left: 1%">
					    <a id="no_notes"> Sem notas. </a>
                    </span>

					<div id="note_comments_icon" style="display: none;float: right " onclick="checkNoteComments()" >

						<svg width="1.5em"  style="position: relative;" height="1.5em" viewBox="0 0 16 16" class="bi bi-chat-left-text" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
							<path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v11.586l2-2A2 2 0 0 1 4.414 11H14a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
							<path fill-rule="evenodd" d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
						</svg>
						<a>&thinsp;</a>
						<a id="note_number_comments" style="font-size: 16px; font-weight: bold;">0</a>


					</div>

				</div>
				<!--
				<div id='notes' style="display: flex; flex-direction: column; justify-content: flex-end; align-items: flex-end">
					<textarea placeholder="Adicionar notas..." id="note" rows="4" cols="50"></textarea>
					<button class="btn light-button" style="margin-top:6px;width: fit-content; background-color: lightgrey; color: #00574B" id="add_note">Submeter <i class="fas fa-paper-plane"></i></button>
				</div>
				-->


				<div id='gallery_header' style="display: none; flex-direction: row; align-items: center; border-top: 1px solid lightgrey;
				padding-top: 12px; margin-top: 12px;">
					<a style="font-size: 18px; color: black; font-weight: bold">Multimédia: </a>
					<span style="margin-left: auto; color: #008577">
						<i class="fas fa-camera" style="font-size: 20px; color: #008577"></i>
						<a id="number_photos" style="font-size: 16px; font-weight: bold"></a>

						<i class="fas fa-microphone" style="margin-left: 20px; font-size: 20px; color: #008577"></i>
						<a id="number_voice_records" style="font-size: 16px; font-weight: bold"></a>
					</span>
				</div>

				<div id='gallery' style=" width: 900px; height: 180px;padding-left: 5%; padding-right: 5%; display: none; flex-direction: row; align-items: center">

					<i class="fas fa-chevron-circle-left" style="width: 5%; font-size: 20px"></i>

                    <div class="gallery" id="photo_gallery">
                    </div>

					<i class="fas fa-chevron-circle-right" style="width: 5%; font-size: 20px"></i>
				</div>


			</div>

			<div style="display: flex; flex-direction: column; justify-content: center; min-width:45%; max-width: 100%; height: 100%;">

				<div id="menu" style="margin-top: 16px;">
					<input id="light-v10" type="radio" name="rtoggle" value="light" />
					<label for="light">Básico</label>
					&nbsp;&nbsp;
					<input id="outdoors-v11" type="radio" name="rtoggle" value="outdoors" />
					<label for="outdoors">Exterior</label>
					&nbsp;&nbsp;
					<input id="satellite-v9" type="radio" name="rtoggle" value="satellite"
						   checked="checked" />
					<label for="satellite">Satélite</label>
				</div>
				<div id="map"></div>
			</div>


		<div id='viz' class='tableauPlaceholder' style='width: 850px; height: 750px; margin-top: 20px; margin-left: 1%; margin-bottom: 10px; border: 1px dashed lightgrey'>
			<object class='tableauViz' width='98%' height='750' style='display:none;'>
				<param name='host_url' value='https%3A%2F%2Feu-west-1a.online.tableau.com%2F' />
				<param name='site_root' value='&#47;t&#47;teachingandresearchinginteractivedatavisualizationdifct' />
				<param name='name' value='AnaliticaObservaes&#47;CapturasObservaesporinimigo' />
				<param name='tabs' value='no' />
				<param name='toolbar' value='no' />
				<param name='showAppBanner' value='false' />
			</object>
		</div>

	</div>

</div>
</div>


<script type='text/javascript'>


	mapboxgl.accessToken = 'pk.eyJ1IjoibWlndWVsYXNjb3JyZWlhIiwiYSI6ImNrN25iYzh4NTAxMHIzc210bzJpM3EyZDcifQ.pVWzek_lEMfJixSnBu1ZMA';

	var CLIENT_ID = '697021054229-c7jjbfpfmjkrnoqjo2pg7nfj7v1a1f95.apps.googleusercontent.com';
	var API_KEY = 'AIzaSyCMSb0abab-1ALwctezS4mWo8AalLXI9KI';

	var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",'https://sheets.googleapis.com/$discovery/rest?version=v4'];
	var SCOPES = 'https://www.googleapis.com/auth/drive';

	/**
	 *  Sign out the user upon button click.
	 */
	function handleSignoutClick() {
		gapi.auth2.getAuthInstance().signOut();
		window.location.href = 'index.html';
	}

	var photos_lock = 1;
	var audio_lock = 1;

	var users = [];
	var visit = [];
	var plotVisits = [];

	var mFocus;
	var mPoints;
	var mPlot;
	var noteFolder = '';
	var imageFolder = '';
	var audioFolder = '';
	var userName = '';
    var userEmail = '';

	var files_map = {};
    var files_info = {};
	var points_by_id = {};

	var actual_file_id ='';

	var map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/mapbox/satellite-v9',
		zoom: 0
	});


	var layerList = document.getElementById('menu');
	var inputs = layerList.getElementsByTagName('input');
	var user = document.getElementById('user_name');

	function switchLayer(layer) {
		var layerId = layer.target.id;
		map.setStyle('mapbox://styles/mapbox/' + layerId);
		map.on('style.load', function() {
			reloadMap();


		});
	}

	for (var i = 0; i < inputs.length; i++) {
		inputs[i].onclick = switchLayer;
	}



	/*var input = document.getElementById('note');
	var button = document.getElementById('add_note');

	button.onclick = function(){
		var text = input.value;
		if(text == null || text == "")
			alert("Campo obrigatório");
		else{

			function pad2(n) { return n < 10 ? '0' + n : n }

			var date = new Date();

			var name = date.getFullYear().toString() + pad2(date.getMonth() + 1) + pad2( date.getDate()) + pad2( date.getHours() ) + pad2( date.getMinutes() ) + pad2( date.getSeconds() );

			text = userName + " ("+ pad2( date.getDate()) + "/" + pad2(date.getMonth() + 1) + "/" +  date.getFullYear().toString() + " " + pad2( date.getHours() )+ ":" + pad2( date.getMinutes() ) + '): ' + text;


			var file = new Blob([text], {type: 'text/plain'});

			var accessToken = gapi.auth.getToken().access_token;

			var form = new FormData();


			if(noteFolder == ''){
				var folderId = getUrlVars()['visit_id'];


				var request = gapi.client.drive.files.create({
					"name" : "Notes",
					"mimeType" : "application/vnd.google-apps.folder",
					"parents" : [folderId],
				});

				request.execute(function(resp) {
					noteFolder = resp.id;

					var metadata = {
						"name" : name,
						"mimeType" : "text/plain",
						"parents" : [noteFolder],
					};

					form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
					form.append('file', file);

					var xhr = new XMLHttpRequest();
					xhr.open('post', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id');
					xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
					xhr.responseType = 'json';
					xhr.onload = () => {
						var a = document.getElementById("no_notes");
						a.innerHTML = "";
						var ul = document.getElementById("notes_ul");
						var li = document.createElement('li');
						ul.appendChild(li);
						li.innerHTML=li.innerHTML + text;
					};
					xhr.send(form);

				});
			}else{
				var metadata = {
					"name" : name,
					"mimeType" : "text/plain",
					"parents" : [noteFolder],
				};

				form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
				form.append('file', file);

				var xhr = new XMLHttpRequest();
				xhr.open('post', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id');
				xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
				xhr.responseType = 'json';
				xhr.onload = () => {
					var a = document.getElementById("no_notes");
					a.innerHTML = "";
					var ul = document.getElementById("notes_ul");
					var li = document.createElement('li');
					ul.appendChild(li);
					li.innerHTML=li.innerHTML + text;
				};
				xhr.send(form);
			}

			input.value = '';
		}
	}*/



	function reloadMap(){

		if(map.getLayer('plot'))
			map.removeLayer('plot');

		if(map.getLayer('route'))
			map.removeLayer('route');


		if(!map.getSource('plot'))
			map.addSource('plot', {
				'type': 'geojson',
				'data': {
					'type': 'Feature',
					'geometry': {
						'type': 'Polygon',
						'coordinates': mPlot
					}
				}
			});

		if(!map.getSource('route'))

			map.addSource('route', {
				'type': 'geojson',
				'data': {
					'type': 'Feature',
					'properties': {},
					'geometry': {
						'type': 'LineString',
						'coordinates': mPoints
					}
				}
			});

		map.addLayer({
			'id': 'plot',
			'type': 'fill',
			'source': 'plot',
			'layout': {},
			'paint': {
				'fill-color': '#55C93D',
				'fill-opacity': 0.4
			}
		});

		map.addLayer({
			'id': 'route',
			'type': 'line',
			'source': 'route',
			'layout': {
				'line-join': 'round',
				'line-cap': 'round'
			},
			'paint': {
				'line-color': '#e55e5e',
				'line-width': 6
			}
		});
	}




	function readTextFile(file, callback) {
		var rawFile = new XMLHttpRequest();
		rawFile.overrideMimeType("application/json");
		rawFile.open("GET", file, true);
		rawFile.onreadystatechange = function() {
			if (rawFile.readyState === 4 && rawFile.status == "200") {
				callback(rawFile.responseText);
			}
		}
		rawFile.send(null);
	}


	function handleClientLoad() {
		gapi.load('client:auth2', initClient);
	}


	function initClient() {
		gapi.client.init({
			apiKey: API_KEY,
			clientId: CLIENT_ID,
			discoveryDocs: DISCOVERY_DOCS,
			scope: SCOPES
		}).then(function () {
			// Listen for sign-in state changes.
			gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

			// Handle the initial sign-in state.
			updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
		}, function(error) {
			appendPre(JSON.stringify(error, null, 2));
		});
	}

	function updateSigninStatus(isSignedIn) {
		auth2 = gapi.auth2.getAuthInstance();
		if (isSignedIn) {
			var profile = auth2.currentUser.get().getBasicProfile();
			userName = profile.getName();
			userEmail = profile.getEmail();
			user.innerHTML = userName;
			user.style.display = 'inline-block';
			listFolder();
		}else
			window.location.href = "index.html";
	}

	//		  function appendPre(message) {
	//			var pre = document.getElementById('content');
	//			var textContent = document.createTextNode(message + '\n');
	//			pre.appendChild(textContent);
	//		  }

	function getUrlVars() {
		var vars = {};
		var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
			vars[key] = value;
		});
		return vars;
	}

	function loadMap(toFocus,plot){
		this.mFocus = toFocus;
		this.mPlot = plot;

		map.flyTo({ center: toFocus, zoom: 15, speed: 10. });

		var layers = map.getStyle().layers;

		var found = false;
		var layerIds = layers.map(function (layer) {
			if(layer.id == 'route')
				found = true;
		});


		map.addSource('plot', {
			'type': 'geojson',
			'data': {
				'type': 'Feature',
				'geometry': {
					'type': 'Polygon',
					'coordinates': plot
				}
			}
		});
		if(found)
			map.addLayer({
				'id': 'plot',
				'type': 'fill',
				'source': 'plot',
				'layout': {},
				'paint': {
					'fill-color': '#55C93D',
					'fill-opacity': 0.4
				}
			},'route');
		else

			map.addLayer({
				'id': 'plot',
				'type': 'fill',
				'source': 'plot',
				'layout': {},
				'paint': {
					'fill-color': '#55C93D',
					'fill-opacity': 0.4
				}
			});

	}


	function addRoute(points, wayPoints){
		this.mPoints = points;

		if(this.photos_lock === 1 || this.audio_lock === 1){
			setTimeout(addRoute, 1000,points,wayPoints);
			return;
		}
		console.log("Lock released");


		for(var i = 0 ; i < wayPoints.length; i++) {
			var id = files_map[wayPoints[i][0].name];
			if (id in files_info) {
				var el = document.createElement('div');
				var isPhoto;
				if (wayPoints[i][0].type > 0) {
					el.className = 'marker_voice';
					isPhoto = false;
				} else {
					el.className = 'marker_image';
					isPhoto = true;
				}
				el.addEventListener("click", function () {
					onPhotoClick(id, files_info[id].name, files_info[id].description, files_info[id].mine, files_info[id].b64Response, isPhoto);
				}, false);


				var point = [wayPoints[i][0].longitude, wayPoints[i][0].latitude];

				points_by_id[id] = wayPoints[i][0];

				new mapboxgl.Marker(el)
						.setLngLat(point)
						.addTo(map);
			}

		}


		map.addSource('route', {
			'type': 'geojson',
			'data': {
				'type': 'Feature',
				'properties': {},
				'geometry': {
					'type': 'LineString',
					'coordinates': points
				}
			}
		});
		map.addLayer({
			'id': 'route',
			'type': 'line',
			'source': 'route',
			'layout': {
				'line-join': 'round',
				'line-cap': 'round'
			},
			'paint': {
				'line-color': '#e55e5e',
				'line-width': 6
			}
		});
	}

	function msToTime(s) {

		function pad(n, z) {
			z = z || 2;
			return ('00' + n).slice(-z);
		}

		var ms = s % 1000;
		s = (s - ms) / 1000;
		var secs = s % 60;
		s = (s - secs) / 60;
		var mins = s ;
		//var hrs = (s - mins) / 60;

		if(mins === 0){
			return pad(secs) + " segundos";
		}else
			return mins + " minutos";
		//return pad(hrs) + ':' + pad(mins) + ':' + pad(secs);
	}



	function getGPX(id){
		gapi.client.drive.files.get({
			'fileId': id,
			'alt': 'media',
		}).then(function(response) {
			var gpx = response.body;
			var trk = gpx.substring(
					gpx.lastIndexOf("<trkseg>") + 8,
					gpx.lastIndexOf("</trkseg>")
			);



			var arrayOfLines = trk.match(/[^\r\n]+/g);
			var points = [];

			for(var w = 0; w < arrayOfLines.length; w++){
				var line = arrayOfLines[w];
				var lat = line.substring(
						line.lastIndexOf('<trkpt lat="') + 12,
						line.lastIndexOf('" lon="')
				);
				var ln = line.substring(
						line.lastIndexOf('lon="') + 5,
						line.lastIndexOf('"><time>')
				);

				var point = [];
				point.push(parseFloat(ln));
				point.push(parseFloat(lat));
				points.push(point);

			}

			var wayPoints = [];

			var wpts  = gpx.substring(
					gpx.indexOf("<wpt "),
					gpx.lastIndexOf("</wpt>")
			);
			var wpts_array = wpts.split("<wpt ");
			for(var k = 0 ; k < wpts_array.length ;k ++){
				var line = wpts_array[k];
				if(line != ""){
					var file_name = line.substring(
							line.lastIndexOf('<name>') + 6,
							line.lastIndexOf('</name>')
					);
					var lat = line.substring(
							line.lastIndexOf('lat="') + 5,
							line.lastIndexOf('" lon="')
					);
					var ln = line.substring(
							line.lastIndexOf('lon="') + 5,
							line.lastIndexOf('"><time>')
					);

					var waypoint = [];
					var file_type;
					if(file_name.includes("photo"))
						file_type = 0;
					else
						file_type = 1;

					var file = {type:file_type, name:file_name, longitude:parseFloat(ln), latitude:parseFloat(lat)};

					waypoint.push(file);
					wayPoints.push(waypoint);
				}


			}

			addRoute(points,wayPoints);


		});
	}

	function getVisitJSON(id){
		gapi.client.drive.files.get({
			'fileId': id,
			'alt': 'media',
		}).then(function(response) {
			var json =  JSON.parse(response.body); //response.body contains the string value of the file
			var plot_id = json['plot_id'];
			var plots_jsons;
			readTextFile("resources/json/parcelas.json", function(text){
				plots_jsons = JSON.parse(text);

				for(var j = 0; j < plots_jsons.features.length; j++){
					var idparcela = plots_jsons.features[j].properties['idparcela'];
					if(idparcela == plot_id){


						/*document.getElementById('plot_name').innerHTML = plots_jsons.features[j].properties['nomeparcela'];

						document.getElementById('number_photos').innerHTML = json['number_photos'];

						document.getElementById('number_voice_records').innerHTML = json['number_voice_records'];

						var begin = json['time_begin'].replace('_','');
						var end = json['time_end'].replace('_','');

						var year = begin.substring(0,4);
						var month = begin.substring(4,6);
						var day = begin.substring(6,8);
						var hour = begin.substring(8,10);
						var min = begin.substring(10,12);

						document.getElementById('begin').innerHTML = day +'/' + month + '/' + year + ' ' + hour + ':' + min



						var begin_date = new Date(begin.replace(
								/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)$/,
								'$4:$5:$6 $2/$3/$1'
						));

						var end_date = new Date(end.replace(
								/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)$/,
								'$4:$5:$6 $2/$3/$1'
						));

						var difference = end_date - begin_date;

						document.getElementById('duration').innerHTML = msToTime(difference);

						document.getElementById("info").style.visibility = "visible";/*/

						var coordinates =  plots_jsons.features[j].geometry.coordinates;
						var toFocus = coordinates[0][0];
						loadMap(toFocus, coordinates);
						break;
					}
				}
				//data.features[0].geometry
			});

		});
	}

	function getPhotos(id){
		gapi.client.drive.files.list({
			'folderId' : id,
			'pageSize': 100,
			'fields': "nextPageToken, files(id, name, description, owners, hasThumbnail, thumbnailLink)",
			'q': `'${id}' in parents`
		}).then(function(response) {
			var files = response.result.files;
			if (files && files.length > 0) {
				document.getElementById("gallery_header").style.display = "flex";
				document.getElementById("gallery").style.display = "flex";


				var div = document.getElementById("photo_gallery");
				div.style.display = "flex";
				for(var i = 0; i < files.length; i++) {
                    (function () {

                    	var last = i === files.length -1;
                        var fileOwner = files[i].owners[0].emailAddress.split(' ').join('');

                        var mine = fileOwner.localeCompare(userEmail) === 0;

                        var id = files[i].id;
                        var name = files[i].name;
                        files_map[name] = id;
                        var description = files[i].description;

                        var imgContainer = document.createElement('a');

                        var a = document.createElement('a');
                        a.style.fontWeight = 'bold';
                        a.style.paddingLeft = '70px';

						var splited_name = files[i].name.split("_");
						var time = splited_name[splited_name.length -1];
                        var hour = time.substring(0, 2);
                        var min = time.substring(2, 4);
                        a.innerHTML = hour + ":" + min;


						var auxDiv = document.createElement('div');
						auxDiv.style.cssFloat = 'left';
						auxDiv.style.display = 'inline-block';


						auxDiv.appendChild(imgContainer);
						auxDiv.appendChild(document.createElement('br'));
						auxDiv.appendChild(a);
						div.appendChild(auxDiv)


                        gapi.client.drive.files.get({
                            'fileId': files[i].id,
                            'alt': 'media',
                        }).then(function (response) {

                            var b64Response = btoa(response.body);

                            var outputImg = document.createElement('img');
                            outputImg.src = 'data:image/png;base64,' + b64Response;
                            outputImg.setAttribute("class", 'image_thumbnail');

							files_info[id] = {name:name, description:description,mine:mine,b64Response:b64Response};


							outputImg.addEventListener("click", function (e) {
								onPhotoClick(id,name,files_info[id].description,mine,b64Response,true);

                            });
                            outputImg.style.objectFit = 'cover';

                            imgContainer.appendChild(outputImg);

                            if(last)
								photos_lock = 0;

                        });
                })();
				}
			}else
				photos_lock = 0;


		});
	}

	function addNewCommentToFile(){




		var timestamp = new Date().toISOString();

		// var timestamp =
		// 		m.getUTCFullYear() + "/" +
		// 		("0" + (m.getUTCMonth()+1)).slice(-2) + "/" +
		// 		("0" + m.getUTCDate()).slice(-2) + " " +
		// 		("0" + m.getUTCHours()).slice(-2) + ":" +
		// 		("0" + m.getUTCMinutes()).slice(-2) + ":" +
		// 		("0" + m.getUTCSeconds()).slice(-2);

		console.log(timestamp);

		var date = new Date(timestamp);
		console.log(date.toString());


		console.log("Ola");
		var comment_input = document.getElementById('file_comment_input');
		var description = comment_input.value;
		if(description) {

			var params = {
				spreadsheetId: '1hqnI8buCJJFgQzgZCfJcEKoDuSpVOhtSfznLCaoRkR8',
				range: 'Folha1!A:E',
				valueInputOption: 'RAW',
				insertDataOption: 'INSERT_ROWS',
			};

			var valueRangeBody = {
				"values": [[actual_file_id,userEmail,userName,description,timestamp]]
			};

			var request = gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody);
			request.then(function(response) {

				var no_comments = document.getElementById('file_no_comments');
				no_comments.style.display = 'none';
				var mainDiv = document.getElementById('file_comments');

				var commentDiv = document.createElement('div');
				var columns = document.createElement('div');
				var firstLine = document.createElement('div');
				var commentText = document.createElement('p');
				var commentOwner = document.createElement('a');
				var commentTimestamp = document.createElement('a');

				var userImage = document.createElement('a');
				var breakLine = document.createElement("br");
				var separator = document.createElement("hr");


				firstLine.style.cssFloat = 'left';
				userImage.style.cssFloat = 'left';

				commentText.innerText = description;
				commentText.style.marginLeft = '30px';
				commentOwner.innerText = userName;
				commentOwner.style.fontSize = '12px';
				commentOwner.style.fontWeight = 'bold';

				commentTimestamp.innerText = timestamp;
				commentTimestamp.style.color = 'gray';
				commentTimestamp.style.fontSize = '12px';

				userImage.innerHTML = getPhotoByName(userName);
				userImage.style.margin = '10px';
				firstLine.appendChild(document.createTextNode(" "));
				firstLine.appendChild(commentOwner);
				firstLine.appendChild(document.createTextNode(" "));
				firstLine.appendChild(commentTimestamp);

				commentDiv.appendChild(firstLine);
				commentDiv.appendChild(breakLine);
				commentDiv.appendChild(commentText);

				columns.appendChild(userImage);
				columns.appendChild(commentDiv)

				mainDiv.appendChild(columns)
				mainDiv.appendChild(separator);

				comment_input.value = '';


			}, function(reason) {
				console.error('error: ' + reason.result.error.message);
			});


		}

	}

	function addNewCommentToNote(){

		var timestamp = new Date().toISOString();

		// var timestamp =
		// 		m.getUTCFullYear() + "/" +
		// 		("0" + (m.getUTCMonth()+1)).slice(-2) + "/" +
		// 		("0" + m.getUTCDate()).slice(-2) + " " +
		// 		("0" + m.getUTCHours()).slice(-2) + ":" +
		// 		("0" + m.getUTCMinutes()).slice(-2) + ":" +
		// 		("0" + m.getUTCSeconds()).slice(-2);

		console.log(timestamp);

		var date = new Date(timestamp);
		console.log(date.toString());

		console.log("Ola");
		var comment_input = document.getElementById('note_comment_input');
		var description = comment_input.value;
		if(description) {
			var no_comments = document.getElementById('note_no_comments');
			no_comments.style.display = 'none';
			var mainDiv = document.getElementById('note_comments');

			var commentDiv = document.createElement('div');
			var columns = document.createElement('div');
			var firstLine = document.createElement('div');
			var commentText = document.createElement('p');
			var commentOwner = document.createElement('a');
			var commentTimestamp = document.createElement('a');

			var userImage = document.createElement('a');
			var breakLine = document.createElement("br");
			var separator = document.createElement("hr");


			firstLine.style.cssFloat = 'left';
			userImage.style.cssFloat = 'left';

			commentText.innerText = description;
			commentText.style.marginLeft = '30px';
			commentOwner.innerText = userName;
			commentOwner.style.fontSize = '12px';
			commentOwner.style.fontWeight = 'bold';

			commentTimestamp.innerText = timestamp;
			commentTimestamp.style.color = 'gray';
			commentTimestamp.style.fontSize = '12px';

			userImage.innerHTML = getPhotoByName(userName);
			userImage.style.margin = '10px';
			firstLine.appendChild(document.createTextNode(" "));
			firstLine.appendChild(commentOwner);
			firstLine.appendChild(document.createTextNode(" "));
			firstLine.appendChild(commentTimestamp);

			commentDiv.appendChild(firstLine);
			commentDiv.appendChild(breakLine);
			commentDiv.appendChild(commentText);

			columns.appendChild(userImage);
			columns.appendChild(commentDiv)

			mainDiv.appendChild(columns)
			mainDiv.appendChild(separator);

			comment_input.value = '';

		}
	}

	function getPhotoByName(user){
		userNames = user.split(' ');
		if(userNames.length > 1)
			return '<a id="user_icon" style="color: white; font-weight: bolder; font-family:sans-serif; font-size: 14px; width: 30px; height: 30px; line-height: unset;' +
					'-webkit-border-radius: 25px; -moz-border-radius: 25px; border-radius: 25px; padding-top:5px;padding-bottom:5px; padding-left:3px; padding-right:3px; background-color: #008577">'
					+ userNames[0].substr(0,1).toUpperCase() + userNames[userNames.length-1].substr(0,1).toUpperCase() + '</a>';
		else
			return '<a id="user_icon" style="color: dimgrey; font-weight: bolder; font-family:sans-serif; font-size: 14px; width: 30px; height: 30px; line-height: unset;' +
					'-webkit-border-radius: 25px; -moz-border-radius: 25px; border-radius: 25px; padding-top:5px;padding-bottom:5px; padding-left:3px; padding-right:3px; background-color: #008577">'
					+ userNames[0].substr(0,1).toUpperCase() + '</a>';

	}



	function onPhotoClick(id,name,description,mine,b64Response,photo){
		actual_file_id = id;

		var modal = document.getElementById("myModal");
		var modal_description = document.getElementById("modal_description");
		var modal_date = document.getElementById("modal_date");

		var modal_number_comments = document.getElementById("modal_number_comments");
		var modal_edit = document.getElementById("modal_edit");
		var modal_locate = document.getElementById("modal_locate");

		var modal_photo = document.getElementById("modal_photo");
		var modal_audio = document.getElementById("modal_audio");


		if(typeof points_by_id[actual_file_id] !== "undefined") {
			modal_locate.style.display = "block";
		}


		modal_date.innerHTML = getDate(name);
		if (typeof description !== "undefined") {
			//modal_description.innerText = "The bar chart represents both the number of visitors per month for each website, and the total number of visitors per website for the entire quarter. Website visitors for each month are represented using columns lined up horizontally, with heights indicating the number of visitors. A fourth column is provided for each website with the accumulated site visitors for the quarter.";
			modal_description.innerText = description;
		} else
			modal_description.innerText = "Sem descrição.";

		if(photo) {
			modal_audio.style.display = "none";
			modal_photo.style.display = "block";
			modal_photo.src = 'data:image/png;base64,' + b64Response;
			modal_photo.width = 300;
		}else{
			modal_audio.style.display = "block";
			modal_photo.style.display = "none";
			modal_audio.src = 'data:audio/mp3;base64,' + b64Response;

		}

		if(mine){
			modal_edit.style.display='block';
		}


		//TODO actualizar o número de comentarios


		modal.style.display = "block";


	}


	function checkNoteComments(){

		var modal = document.getElementById('note_modal');
		var modal_description = document.getElementById('note_modal_description');
		modal_description.innerText = visit.notes;

		modal.style.display='block';
	}

	function zoomOnMap() {
		onModalClose();
		map.flyTo({
			center: [
				points_by_id[actual_file_id].longitude,
				points_by_id[actual_file_id].latitude

			],
			essential: true // this animation is considered essential with respect to prefers-reduced-motion
		});
	}

	function onModalClose() {
		document.getElementById('myModal').style.display = 'none';
		var comments_div = document.getElementById('file_comments');
		var file_no_comments = document.getElementById('file_no_comments');
		file_no_comments.style.display = 'block';
		comments_div.innerHTML = '';
		comments_div.appendChild(file_no_comments)
		cancelEdit();
	}

	function tryEdit(){
		var editIcon = document.getElementById("modal_edit");
		var closeIcon = document.getElementById("modal_edit_close");
		var confirmIcon = document.getElementById("modal_edit_confirm");
		var modal_locate = document.getElementById("modal_locate");

		var description = document.getElementById("modal_description");
		var description_input = document.getElementById("modal_description_edit");

		description.style.display = 'none';
		description_input.style.display = 'block';
		if(description.innerText.localeCompare("Sem descrição.") !== 0)
			description_input.value = description.innerText;
		editIcon.style.display = 'none';
		modal_locate.style.display = 'none';
		closeIcon.style.display = 'block';
		confirmIcon.style.display = 'block';

		description_input.focus();

	}

	function cancelEdit(){
		var editIcon = document.getElementById("modal_edit");
		var closeIcon = document.getElementById("modal_edit_close");
		var confirmIcon = document.getElementById("modal_edit_confirm");

		var description = document.getElementById("modal_description");
		var description_input = document.getElementById("modal_description_edit");

		var modal_locate = document.getElementById("modal_locate");

		if(typeof points_by_id[actual_file_id] !== "undefined") {
			modal_locate.style.display = "block";
		}

		description.style.display = 'block';
		description_input.style.display = 'none';
		description_input.value = "";
		editIcon.style.display = 'block';
		closeIcon.style.display = 'none';
		confirmIcon.style.display = 'none';

	}

	function confirmEdit() {
		console.log("vai tentar");
		var editIcon = document.getElementById("modal_edit");
		var closeIcon = document.getElementById("modal_edit_close");
		var confirmIcon = document.getElementById("modal_edit_confirm");
		var modal_locate = document.getElementById("modal_locate");

		var description = document.getElementById("modal_description");
		var description_input = document.getElementById("modal_description_edit");
		if(description_input.value && description_input.value.localeCompare(description.innerText) !==0){
			console.log("tentou");
			var body = {'description': description_input.value};
			var request = gapi.client.drive.files.update({
				'fileId': actual_file_id,
				'resource': body
			});
			request.execute(function(resp) {
				description.style.display = 'block';
				description.innerText = description_input.value;
				description_input.style.display = 'none';
				description_input.value = "";
				editIcon.style.display = 'block';
				closeIcon.style.display = 'none';
				confirmIcon.style.display = 'none';


				if(typeof points_by_id[actual_file_id] !== "undefined") {
					modal_locate.style.display = "block";
				}

				files_info[actual_file_id].description = description.innerText;
				console.log(files_info[actual_file_id]);
			});

		}else {
			description.style.display = 'block';
			description_input.style.display = 'none';
			description_input.value = "";
			editIcon.style.display = 'block';
			closeIcon.style.display = 'none';
			confirmIcon.style.display = 'none';

			if(typeof points_by_id[actual_file_id] !== "undefined") {
				modal_locate.style.display = "block";
			}
		}



	}

	function getMonth(month) {
        switch (month) { //get month
            case '01':
                month = " Jan ";
                break;
            case '02':
                month = " Fev ";
                break;
            case '03':
                month = " Mar ";
                break;
            case '04':
                month = " Abr ";
                break;
            case '05':
                month = " Mai ";
                break;
            case '06':
                month = " Jun ";
                break;
            case '07':
                month = " Jul ";
                break;
            case '08':
                month = " Ago ";
                break;
            case '09':
                month = " Set ";
                break;
            case '10':
                month = " Out ";
                break;
            case '11':
                month = " Nov ";
                break;
            case '12':
                month = " Dez ";
                break;
        }
        return month
    }



	function getDate(name) {
		console.log(name);
        var splittedName = name.split('_');
        var raw_time = splittedName[splittedName.length-1];
        var raw_day = splittedName[splittedName.length-2];

        var day = raw_day.substr(6,2);
        if(day.charAt(0) === '0'){
            day = day.substr(1,1);
        }

        var month = getMonth(raw_day.substr(4,2));

        var hour = raw_time.substr(0,2);
        var minutes = raw_time.substr(2,2);

        return day + " de " + month + " às " + hour + ":"+minutes;
    }

	function getAudios(id){
		gapi.client.drive.files.list({
			'folderId' : id,
			'pageSize': 100,
			'fields': "nextPageToken, files(id, name, description, owners)",
			'q': `'${id}' in parents`
		}).then(function(response) {
			var files = response.result.files;
			if (files && files.length > 0) {
				document.getElementById("gallery_header").style.display = "flex";
				document.getElementById("gallery").style.display = "flex";

				var div = document.getElementById("photo_gallery");

				div.style.display = "flex";

				for(var i = 0; i < files.length; i++) {
					(function () {

						var last = i === files.length -1;

						var fileOwner = files[i].owners[0].emailAddress.split(' ').join('');

						var mine = fileOwner.localeCompare(userEmail) === 0;

						var id = files[i].id;
						var name = files[i].name;
						files_map[name] = id;
						var description = files[i].description;

						var imgContainer = document.createElement('a');

						var a = document.createElement('a');
						a.style.fontWeight = 'bold';
						a.style.paddingLeft = '70px';

						var splited_name = files[i].name.split("_");
						var time = splited_name[splited_name.length -1];

						var hour = time.substring(0, 2);
						var min = time.substring(2, 4);
						a.innerHTML = hour + ":" + min;


						var auxDiv = document.createElement('div');
						auxDiv.style.cssFloat = 'left';
						auxDiv.style.display = 'inline-block';

						auxDiv.appendChild(imgContainer);
						auxDiv.appendChild(document.createElement('br'));
						auxDiv.appendChild(a);
						div.appendChild(auxDiv)



						gapi.client.drive.files.get({
							'fileId': id,
							'alt': 'media',
						}).then(function (response) {
							var b64Response = btoa(response.body);

							var outputImg = document.createElement('img');
							outputImg.src = 'resources/images/audio_icon.png';
							outputImg.setAttribute("class", 'image_thumbnail');

							files_info[id] = {name:name, description:description,mine:mine,b64Response:b64Response};

							outputImg.addEventListener("click", function (e) {
								onPhotoClick(id,name,files_info[id].description,mine,b64Response,false);
							});


							outputImg.style.objectFit = 'cover';

							imgContainer.appendChild(outputImg);

							if(last)
								audio_lock = 0;


						});


					})();
				}
			}else
				audio_lock = 0;

		});
	}



	function getNotes(id){
		gapi.client.drive.files.list({
			'folderId' : id,
			'pageSize': 100,
			'fields': "nextPageToken, files(id, name)",
			'q': `'${id}' in parents`
		}).then(function(response) {
			var files = response.result.files;
			if (files && files.length > 0) {
				var a = document.getElementById("no_notes");
				a.innerHTML = "";
				var div = document.getElementById("note_gallery");
				var ul = document.getElementById("notes_ul");
				for(var i = 0; i < files.length; i++){
					gapi.client.drive.files.get({
						'fileId': files[i].id,
						'alt': 'media',
					}).then(function(response) {
						var li = document.createElement('li');
						ul.appendChild(li);
						li.innerHTML=li.innerHTML + response.body;

					});
				}
			}
		});
	}

	function appendPre(message) {
		var pre = document.getElementById('content');
		var textContent = document.createTextNode(message + '\n');
		pre.appendChild(textContent);
	}

	function listFolder() {
		var fileId = getUrlVars()['visit_id'];
		var json_id = '';
		var gpx_id = '';
		var photo_id = '';
		var audio_id = '';

		gapi.client.drive.files.list({
			'folderId' : fileId,
			'pageSize': 100,
			'fields': "nextPageToken, files(id, name)",
			'q': `'${fileId}' in parents`
		}).then(function(response) {
			var files = response.result.files;
			if (files && files.length > 0) {
				for(var i = 0; i < files.length; i++){

					var id = files[i].id;

					if(files[i].name.includes('json')){
						json_id = id;
						//getVisitJSON(id);
					}
					else if(files[i].name.includes('gpx')){
						gpx_id = id;
						//getGPX(files[i].id);
					}
					else if(files[i].name == 'Photos'){
						photo_id = id;
						//getPhotos(files[i].id);
					}
					else if(files[i].name == 'Audio'){
						audio_id = id;
						//getAudios(files[i].id);

					}
					else if(files[i].name == 'Notes'){
						//getNotes(files[i].id);
						noteFolder = files[i].id;
					}
				}
				if(noteFolder != '')
					getNotes(noteFolder)
				if(photo_id != '')
					getPhotos(photo_id);
				else
					photos_lock = 0;
				if(audio_id != '')
					getAudios(audio_id);
				else
					audio_lock = 0;


				if(json_id != '') {
					getVisitJSON(json_id);
					// TODO: se o session storage tiver vazio, ir buscar ficheiro e carregar visitas do pob
					users = [];
					users = JSON.parse(sessionStorage.getItem("users"));
					visit = [];
					visit = JSON.parse(sessionStorage.getItem("visit"));
					plotVisits = [];
					plotVisits = JSON.parse(sessionStorage.getItem("plotVisits"));
					var visitIndex = plotVisits.findIndex(value => value.fileId === visit.fileId);
					var lastVisit = (visitIndex === 0 ? "Sem visita anterior" : refactorDate(plotVisits[visitIndex-1].date));
					var nextVisit = (visitIndex === plotVisits.length-1 ? "Sem visita seguinte" : refactorDate(plotVisits[visitIndex+1].date));
					document.getElementById('plot_name').innerHTML = visit.plotName + ` (${visit.plot})`;
					document.getElementById('last_visit').innerHTML = lastVisit;
					document.getElementById('last_visit_area').fileId = (lastVisit === "Sem visita anterior" ? null : plotVisits[visitIndex-1].fileId);
					document.getElementById('last_visit_area').style.color = (lastVisit === "Sem visita anterior" ? 'darkgrey' : 'black');
					document.getElementById('last_visit_area').style.cursor = (lastVisit === "Sem visita anterior" ? 'default' : 'pointer');
					document.getElementById('last_visit_area').onclick = function(){
						if(this.fileId != null){
							sessionStorage.setItem("visit", JSON.stringify(plotVisits.find(value => value.fileId === this.fileId)));
							window.location.href = 'visit.html?visit_id=' + this.fileId;
						}
					};
					document.getElementById('next_visit').innerHTML = nextVisit;
					document.getElementById('next_visit_area').style.color = (nextVisit === "Sem visita seguinte" ? 'darkgrey' : 'black');
					document.getElementById('next_visit_area').style.cursor = (nextVisit === "Sem visita seguinte" ? 'default' : 'pointer');
					document.getElementById('next_visit_area').fileId = (nextVisit === "Sem visita seguinte" ? null : plotVisits[visitIndex+1].fileId);
					document.getElementById('next_visit_area').onclick = function(){
						if(this.fileId != null){
							sessionStorage.setItem("visit", JSON.stringify(plotVisits.find(value => value.fileId === this.fileId)));
							window.location.href = 'visit.html?visit_id=' + this.fileId;
						}
					};
					document.getElementById('number_photos').innerHTML = visit.numPhotos;
					document.getElementById('number_voice_records').innerHTML = visit.numVoice;
					document.getElementById('begin').innerHTML = refactorDate(visit.date) + " às " + visit.tBegin;
					document.getElementById('duration').innerHTML = secondsToTime(visit.duration);

					if(visit.notes.localeCompare("null") !== 0) {
						document.getElementById('no_notes').innerHTML = visit.notes;
						document.getElementById('note_comments_icon').style.display = 'block';
					}else{
						console.log("Sem notas");

					}

					console.log(users);
					var technicians = visit.technicians;
					technicians = technicians.replace(';', ' & ');
					document.getElementById('technician').innerHTML = technicians;
					document.getElementById('ef').innerHTML = visit.ef;
					if(visit.nea !== "null"){
						document.getElementById('nea_text').style.display = 'inline';
						document.getElementById('nea').innerText = visit.nea;
					}

                    var date = visit.date.split("/");
					var filterDate = date[0] + "-" + date[1] + "-" + date[2];

					//TODO: descomentar quando as visitas forem as reais para filtrar a visualização para a visita real
                    //var viz = document.getElementById('viz').getElementsByTagName('iframe').item(0);
					//viz.src += `&codigoparcela=${visit.plot}&datavisita=${filterDate}`;

                    document.getElementById("info").style.visibility = "visible";

				}
				if(gpx_id != '')
					getGPX(gpx_id);

			} else {
				appendPre('No files found.');
			}
		});
	}

	function secondsToTime(seconds) {
		if(seconds < 60)
			return seconds + " segundos";
		else {
			var minutes = Math.round(seconds / 60);
			if(minutes < 60)
				return minutes + " minutos";
			else{
				var hours = Math.trunc(minutes / 60);
				if(Math.round(minutes - hours*60) > 0)
					return hours + " horas e " + Math.round(minutes - hours*60) + " minutos";
				else
					return hours + " horas";
			}

		}
	}


	function refactorDate(date) {
		var values = date.split('/');
		var month = "";
		switch (values[1]) { //get month
			case '01':
				month = " Jan ";
				break;
			case '02':
				month = " Fev ";
				break;
			case '03':
				month = " Mar ";
				break;
			case '04':
				month = " Abr ";
				break;
			case '05':
				month = " Mai ";
				break;
			case '06':
				month = " Jun ";
				break;
			case '07':
				month = " Jul ";
				break;
			case '08':
				month = " Ago ";
				break;
			case '09':
				month = " Set ";
				break;
			case '10':
				month = " Out ";
				break;
			case '11':
				month = " Nov ";
				break;
			case '12':
				month = " Dez ";
				break;
		}
		return values[2] + month /*+ values[0].substr(2)*/;
	}

</script>

<script async defer src="https://apis.google.com/js/api.js"
		onload="this.onload=function(){};handleClientLoad()"
		onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>


</body>


</html>
